

<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SOL Quiz Application</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            deepBlue: '#1e3a8a',
            highlight: '#f97316',
          },
          animation: {
            'slide-in-right': 'slideInRight 0.5s ease-out forwards',
            'pulse-fast': 'pulse 0.8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'slide-up-fade': 'slideUpFade 0.4s ease-out forwards',
            'fade-in': 'fadeIn 0.6s ease-out forwards',
          },
          keyframes: {
            slideInRight: {
              '0%': { opacity: '0', transform: 'translateX(20px)' },
              '100%': { opacity: '1', transform: 'translateX(0)' },
            },
            slideUpFade: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            }
          }
        }
      }
    }
  </script>
  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #f97316;
      animation: spin 1s ease infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .text-gradient-gold { background: linear-gradient(to right, #b45309, #d97706, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .text-gradient-red { background: linear-gradient(to right, #991b1b, #dc2626, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .text-gradient-purple { background: linear-gradient(to right, #6b21a8, #a855f7, #d8b4fe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .text-gradient-zen { background: linear-gradient(to right, #374151, #6b7280, #9ca3af); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .text-glow { text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 165, 0, 0.5); }
    
    html { scroll-behavior: smooth; }
    .quiz-block { transition: opacity 0.3s ease-in-out; }
    .quiz-block-hidden { display: none; opacity: 0; }
    .quiz-block-visible { display: block; opacity: 1; }

    @keyframes occasional-shine {
      0%, 80% { text-shadow: none; filter: brightness(1); }
      85% { text-shadow: 0 0 15px rgba(255,255,255,0.8), 0 0 30px rgba(249, 115, 22, 0.6); filter: brightness(1.3); }
      90% { text-shadow: none; filter: brightness(1); }
      100% { text-shadow: none; filter: brightness(1); }
    }
    .animate-shine-slow { animation: occasional-shine 6s infinite ease-in-out; }
    
    @keyframes gradient-slide {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    .header-attention-border { position: relative; }
    .header-attention-border::after {
        content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; 
        background: linear-gradient(90deg, #f97316, #ef4444, #f59e0b, #f97316); 
        background-size: 300% 100%; animation: gradient-slide 3s ease infinite;
        box-shadow: 0 -2px 20px rgba(249, 115, 22, 0.6); z-index: 50;
    }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex flex-col items-center justify-center hidden">
    <div class="spinner mb-4"></div>
    <p class="text-deepBlue font-semibold" id="loading-text">ƒêang x·ª≠ l√Ω...</p>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all scale-100 border-t-4 border-highlight">
      <div class="flex items-center gap-3 mb-4 text-highlight">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h3 class="text-3xl font-bold text-highlight">X√°c nh·∫≠n n·ªôp b√†i</h3>
      </div>
      <p id="confirm-modal-text" class="text-gray-600 mb-6 leading-relaxed">...</p>
      <div class="flex justify-end gap-3">
        <button onclick="closeConfirmModal()" class="px-5 py-2.5 rounded-lg border border-blue-200 text-blue-700 font-bold hover:bg-blue-50 transition focus:outline-none focus:ring-2 focus:ring-blue-300">Quay l·∫°i l√†m ti·∫øp</button>
        <button id="confirm-modal-btn" class="px-5 py-2.5 rounded-lg bg-highlight text-white font-bold hover:bg-orange-600 shadow-lg transition focus:outline-none focus:ring-2 focus:ring-orange-500">V·∫´n n·ªôp b√†i</button>
      </div>
    </div>
  </div>

  <!-- DISC Instruction Popup -->
  <div id="disc-instruction-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 border-l-8 border-blue-600 animate-slide-up-fade">
        <h3 class="text-2xl font-bold text-deepBlue mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            H∆∞·ªõng d·∫´n l√†m b√†i test
        </h3>
        <ul class="list-disc pl-5 space-y-3 text-gray-700 text-base leading-relaxed mb-8">
            <li>H√¨nh dung b·ªëi c·∫£nh khi ch·ªçn c√¢u tr·∫£ l·ªùi l√† ƒëang <b>‚Äú·ªû n∆°i l√†m vi·ªác‚Äù</b> cho b√†i test n√†y.</li>
            <li>ƒê·ªçc k·ªπ c√°c c·ª•m t·ª´ m√¥ t·∫£ t√≠nh c√°ch ·ªü m·ªói c√¢u h·ªèi ƒë·ªÉ Ch·ªçn m·ªôt trong 02 ph∆∞∆°ng √°n <b>‚ÄúGi·ªëng t√¥i nh·∫•t‚Äù</b> ho·∫∑c <b>‚Äú√çt gi·ªëng t√¥i nh·∫•t‚Äù</b>.</li>
            <li>·ª®ng v·ªõi m·ªói block, ch·ªâ ch·ªçn <b>M·ªòT c√¢u tr·∫£ l·ªùi</b> ‚ÄúGi·ªëng t√¥i nh·∫•t‚Äù v√† <b>M·ªòT c√¢u tr·∫£ l·ªùi</b> ‚Äú√çt gi·ªëng t√¥i nh·∫•t‚Äù.</li>
            <li>ƒê·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c, <span class="font-bold text-red-600">To√†n b·ªô b√†i test n√†y ch·ªâ n√™n ho√†n t·∫•t trong v√≤ng 7 PH√öT, ho·∫∑c c√†ng nhanh c√†ng t·ªët.</span> Do ƒë√≥ h√£y s·∫µn s√†ng tinh th·∫ßn l√†m l·∫°i t·ª´ ƒë·∫ßu n·∫øu v∆∞·ª£t qu√° 7 ph√∫t m√† ch∆∞a l√†m b√†i xong.</li>
        </ul>
        <div class="flex justify-center">
            <button onclick="startDiscTestNow()" class="bg-highlight hover:bg-orange-600 text-white text-xl font-bold py-3 px-10 rounded-full shadow-lg transition transform hover:scale-105">OK, B·∫Øt ƒë·∫ßu l√†m b√†i</button>
        </div>
    </div>
  </div>

  <!-- DISC Timeout Modal -->
  <div id="disc-timeout-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4 border-t-4 border-red-500 animate-slide-up-fade">
        <div class="flex items-center gap-3 mb-4 text-red-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <h3 class="text-3xl font-bold">H·∫øt gi·ªù l√†m b√†i!</h3>
        </div>
        <div class="text-gray-700 text-xl leading-relaxed mb-6">
            <p class="mb-4">B√†i test ch·ªâ ƒë·∫°t ch√≠nh x√°c cao khi b·∫°n <span class="text-blue-600 font-bold">tr·∫£ l·ªùi nhanh b·∫±ng ti·ªÅm th·ª©c, kh√¥ng suy nghƒ© l√Ω tr√≠,</span> t·ªïng th·ªùi gian l√†m b√†i test <span class="text-blue-600 font-bold">kh√¥ng qu√° 7 ph√∫t.</span></p>
            <p class="text-right text-red-600 font-bold">B·∫°n c√≥ mu·ªën l√†m l·∫°i kh√¥ng?</p>
        </div>
        <div class="flex justify-end gap-3">
            <button onclick="document.getElementById('disc-timeout-modal').classList.add('hidden'); returnToHome()" class="px-5 py-2.5 rounded-lg border border-gray-300 text-gray-700 font-bold hover:bg-gray-100 transition text-lg">Kh√¥ng</button>
            <button onclick="resetDiscTest()" class="px-5 py-2.5 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700 shadow-lg transition text-lg">C√≥, l√†m l·∫°i</button>
        </div>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-deepBlue text-white p-4 shadow-lg sticky top-0 z-40 h-20 flex items-center header-attention-border">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <h1 class="text-4xl font-bold tracking-wide animate-shine-slow cursor-default">SOL<span class="text-highlight">Quiz</span></h1>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto p-4 md:p-6 relative">

    <!-- VIEW 1: HOME -->
    <div id="view-home" class="view-section animate-fade-in">
      <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-8 mt-10">
        <!-- Student Panel -->
        <div class="bg-white p-8 rounded-xl shadow-md border-t-4 border-highlight order-1 md:order-2">
          <h2 class="text-2xl font-bold text-deepBlue mb-2">For Participants</h2>
          <div class="mb-4">
            <select id="student-test-select" class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-deepBlue focus:outline-none bg-white text-gray-900">
              <option value="" disabled selected>ƒêang t·∫£i d·ªØ li·ªáu...</option>
            </select>
          </div>
          <button onclick="startQuizFlow()" class="w-full bg-deepBlue hover:bg-blue-800 text-white font-bold py-3 px-4 rounded transition duration-200">Get Inside</button>
        </div>

        <!-- Admin Panel -->
        <div class="bg-white p-8 rounded-xl shadow-md border-t-4 border-deepBlue order-2 md:order-1 transition-all">
          <div class="flex justify-between items-center cursor-pointer group" onclick="toggleAdminLogin()">
             <h2 class="text-2xl font-bold text-highlight mb-2 group-hover:text-orange-600">Prime NT-301 Nexus</h2>
          </div>
          <div id="admin-login-form" class="space-y-4 hidden mt-4 animate-slide-up-fade">
            <div><input type="text" id="admin-user" class="w-full p-3 border rounded bg-white text-gray-900" placeholder="Alias" onkeypress="if(event.key === 'Enter') handleAdminLogin()"></div>
            <div><input type="password" id="admin-pass" class="w-full p-3 border rounded bg-white text-gray-900" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key === 'Enter') handleAdminLogin()"></div>
            <button onclick="handleAdminLogin()" class="w-full bg-highlight hover:bg-orange-600 text-white font-bold py-3 rounded transition shadow-md">Proceed</button>
          </div>
        </div>
      </div>
      <div class="mt-16 text-center text-blue-600 text-sm font-bold opacity-80">Copyright @ SOL English Land</div>
    </div>
    
    <!-- Rest of VIEW sections (Admin, Quiz, Result, DISC Result) remain unchanged in structure -->
    <!-- VIEW 2: ADMIN DASHBOARD -->
    <div id="view-admin" class="view-section hidden">
      <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
          <div>
              <h2 class="text-3xl font-bold text-deepBlue">SOL<span class="text-highlight">Quiz</span> Dashboard</h2>
              <div class="flex flex-wrap gap-2 mt-2">
                 <div id="admin-role-badge" class="hidden inline-flex items-center gap-1 px-3 py-1 rounded-full bg-purple-50 text-purple-700 text-xs font-bold border border-purple-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    <span id="admin-role-text">Role</span>
                 </div>
                 <div id="admin-dept-badge" class="hidden inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd" /></svg>
                    <span id="admin-dept-text">Department</span>
                 </div>
                 <div id="admin-area-badge" class="hidden inline-flex items-center gap-1 px-3 py-1 rounded-full bg-orange-50 text-orange-700 text-xs font-bold border border-orange-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span id="admin-area-text">Area</span>
                 </div>
              </div>
          </div>
          <button onclick="exitAdminView()" class="group flex items-center gap-2 text-gray-500 hover:text-red-600 transition font-medium px-4 py-2 rounded-lg hover:bg-red-50">
            <span>ƒêƒÉng xu·∫•t</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform group-hover:translate-x-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
        
        <!-- TABS -->
        <div class="flex border-b border-gray-200 mb-6">
           <button id="tab-btn-quiz" onclick="switchAdminTab('quiz')" class="hidden py-4 px-6 border-b-4 font-bold text-lg focus:outline-none transition-colors duration-200 border-highlight text-highlight">Quiz</button>
           <button id="tab-btn-disc" onclick="switchAdminTab('disc')" class="hidden py-4 px-6 border-b-4 font-bold text-lg focus:outline-none transition-colors duration-200 border-transparent text-gray-400 hover:text-gray-600 hover:border-gray-300">DISC</button>
        </div>
        
        <!-- TAB CONTENT: QUIZ -->
        <div id="tab-content-quiz">
            <div class="bg-white p-6 rounded-lg shadow mb-8 flex flex-col md:flex-row gap-4 md:items-end">
              <div class="flex-grow">
                <label class="block text-xs sm:text-sm font-medium mb-1 whitespace-nowrap overflow-hidden text-ellipsis">Ch·ªçn b√†i thi ƒë·ªÉ xem b√°o c√°o</label>
                <select id="admin-test-select" class="w-full p-2 border rounded bg-white text-gray-900"></select>
              </div>
              <button onclick="loadResults()" class="bg-highlight text-white font-bold py-3 px-8 text-lg rounded-lg shadow-lg hover:bg-orange-600 transition transform hover:scale-105">Xem b√°o c√°o (Realtime)</button>
            </div>
            <div id="admin-dashboard-content" class="hidden">
               <!-- Quiz Chart -->
               <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                 <h3 class="text-[21px] font-extrabold text-deepBlue mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-highlight" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    Bi·ªÉu ƒë·ªì k·∫øt qu·∫£ th√≠ sinh
                 </h3>
                 <div id="chart-container" class="w-full relative" style="height: 400px;"><canvas id="adminResultsChart"></canvas></div>
                 <div class="flex justify-center mt-6 border-t pt-4">
                    <button onclick="scrollToPassList()" class="group flex items-center gap-2 px-5 py-2 bg-white border border-blue-200 rounded-full shadow-sm hover:shadow-md hover:border-blue-400 transition cursor-pointer text-blue-600">
                      <span class="font-bold text-sm group-hover:underline">Xem danh s√°ch th√≠ sinh ƒë√£ pass T·∫†I ƒê√ÇY</span>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                    </button>
                 </div>
               </div>
               <!-- Special Badges -->
               <div class="grid md:grid-cols-2 gap-8 mb-8">
                  <div id="badge-god" class="bg-gradient-to-r from-yellow-50 to-white border-4 border-yellow-400 p-8 rounded-2xl shadow-2xl relative overflow-hidden hidden text-center transform hover:scale-105 transition duration-300">
                     <h4 class="text-gradient-gold text-3xl font-black uppercase tracking-widest mb-2 drop-shadow-md animate-pulse-fast">üèÜ Danh hi·ªáu: Chi·∫øn Th·∫ßn</h4>
                     <p class="text-xs font-semibold text-yellow-700 mb-4 uppercase tracking-wide bg-yellow-100 inline-block px-3 py-1 rounded-full border border-yellow-200">Nhanh nh·∫•t + ƒêi·ªÉm cao nh·∫•t</p>
                     <div class="relative z-10"><p class="text-3xl font-extrabold text-gray-800" id="god-name">...</p><div class="mt-4 inline-block bg-blue-50 px-6 py-3 rounded-xl border border-blue-100 shadow-inner"><p class="text-base font-bold text-deepBlue" id="god-desc">...</p></div></div>
                  </div>
                  <div id="badge-furious" class="bg-gradient-to-r from-red-50 to-white border-4 border-red-400 p-8 rounded-2xl shadow-2xl relative overflow-hidden hidden text-center transform hover:scale-105 transition duration-300">
                     <h4 class="text-gradient-red text-3xl font-black uppercase tracking-widest mb-2 drop-shadow-md animate-pulse-fast">‚ö° Danh hi·ªáu: Qu√° Nhanh - Qu√° Nguy Hi·ªÉm</h4>
                     <div class="relative z-10"><p class="text-3xl font-extrabold text-gray-800" id="furious-name">...</p><div class="mt-4 inline-block bg-blue-50 px-6 py-3 rounded-xl border border-blue-100 shadow-inner"><p class="text-xl font-bold text-deepBlue" id="furious-desc">...</p></div></div>
                  </div>
                  <div id="badge-hint" class="bg-gradient-to-r from-purple-50 to-white border-4 border-purple-400 p-8 rounded-2xl shadow-2xl relative overflow-hidden hidden text-center transform hover:scale-105 transition duration-300">
                     <h4 class="text-gradient-purple text-3xl font-black uppercase tracking-widest mb-2 drop-shadow-md animate-pulse-fast">üí° Danh hi·ªáu: Th√°nh b·∫•m G·ª£i √Ω</h4>
                     <div class="relative z-10"><p class="text-3xl font-extrabold text-gray-800" id="hint-name">...</p><div class="mt-4 inline-block bg-purple-50 px-6 py-3 rounded-xl border border-purple-100 shadow-inner"><p class="text-base font-bold text-purple-900" id="hint-desc">...</p></div></div>
                  </div>
                  <div id="badge-zen" class="bg-gradient-to-r from-gray-50 to-white border-4 border-gray-400 p-8 rounded-2xl shadow-2xl relative overflow-hidden hidden text-center transform hover:scale-105 transition duration-300">
                     <h4 class="text-gradient-zen text-3xl font-black uppercase tracking-widest mb-2 drop-shadow-md animate-pulse-fast">üßò Danh hi·ªáu: Thi·ªÅn s∆∞ Submit</h4>
                     <div class="relative z-10"><p class="text-3xl font-extrabold text-gray-800" id="zen-name">...</p><div class="mt-4 inline-block bg-gray-100 px-6 py-3 rounded-xl border border-gray-200 shadow-inner"><p class="text-base font-bold text-gray-800" id="zen-desc">N·ªôp b√†i cu·ªëi c√πng</p></div></div>
                  </div>
               </div>
               <!-- Pass List -->
               <div id="pass-list-section" class="bg-white rounded-xl shadow overflow-hidden">
                 <div class="bg-green-600 px-6 py-4 flex justify-between items-center"><h3 class="text-white font-bold text-xl">Danh s√°ch Pass Test</h3></div>
                 <div class="overflow-x-auto">
                   <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50"><tr>
                          <th class="px-2 py-3 md:px-6 md:py-4 text-left text-xs md:text-xl font-bold text-gray-500 uppercase">H·∫°ng</th>
                          <th class="px-2 py-3 md:px-6 md:py-4 text-left text-xs md:text-xl font-bold text-gray-500 uppercase">Th√≠ sinh</th>
                          <th class="px-2 py-3 md:px-6 md:py-4 text-left text-xs md:text-xl font-bold text-gray-500 uppercase">V·ªã tr√≠</th>
                          <th class="px-2 py-3 md:px-6 md:py-4 text-left text-xs md:text-xl font-bold text-gray-500 uppercase">T·ªïng ƒëi·ªÉm</th>
                          <th class="px-2 py-3 md:px-6 md:py-4 text-left text-xs md:text-xl font-bold text-gray-500 uppercase">G·ª£i √Ω</th>
                      </tr></thead>
                      <tbody id="pass-list-body" class="bg-white divide-y divide-gray-200"></tbody>
                   </table>
                 </div>
               </div>
            </div>
            <div id="admin-empty-msg" class="text-center py-12 text-gray-500 italic hidden">Ch∆∞a c√≥ d·ªØ li·ªáu cho b√†i thi n√†y.</div>
        </div>

        <!-- TAB CONTENT: DISC -->
        <div id="tab-content-disc" class="hidden">
           <!-- Overview Analysis Section (Redesigned) -->
           <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-8 border-green-600"> 
             <h3 class="text-2xl font-bold text-deepBlue mb-6 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                Ph√¢n t√≠ch t·ªïng quan
             </h3>

             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8"> <!-- 3 Columns Grid -->
                
                <!-- Column 1: Controls & Stats -->
                <div class="bg-blue-50 p-6 rounded-xl flex flex-col gap-6 h-full justify-center">
                    <h4 class="font-bold text-gray-700 uppercase border-b border-blue-200 pb-2">B·ªô l·ªçc d·ªØ li·ªáu</h4>
                    
                    <!-- Radio Mode -->
                    <div class="flex flex-col gap-3">
                       <label class="flex items-center gap-2 cursor-pointer hover:bg-white p-2 rounded transition">
                          <input type="radio" name="discFilterMode" value="occasion" checked onchange="toggleDiscFilterMode()" class="form-radio text-deepBlue h-5 w-5">
                          <span class="font-bold text-gray-700">Theo ƒê·ª£t (Occasion)</span>
                       </label>
                       <label class="flex items-center gap-2 cursor-pointer hover:bg-white p-2 rounded transition">
                          <input type="radio" name="discFilterMode" value="topic" onchange="toggleDiscFilterMode()" class="form-radio text-highlight h-5 w-5">
                          <span class="font-bold text-gray-700">Theo Ch·ªß ƒë·ªÅ (Topic)</span>
                       </label>
                    </div>

                    <!-- Inputs -->
                    <div id="container-filter-occasion" class="w-full">
                       <label class="text-xs font-bold text-gray-500 mb-1 block">Ch·ªçn ƒë·ª£t thi:</label>
                       <select id="disc-filter-occasion" onchange="processDiscData()" class="w-full p-3 border border-blue-200 rounded-lg bg-white text-gray-800 shadow-sm focus:ring-2 focus:ring-blue-400 outline-none font-medium">
                          <option value="ALL">T·∫•t c·∫£</option>
                       </select>
                    </div>
                    
                    <div id="container-filter-topic" class="w-full hidden">
                       <label class="text-xs font-bold text-gray-500 mb-1 block">Ch·ªçn t·ª´ kh√≥a:</label>
                       <div class="flex gap-1">
                         <select id="disc-filter-topic" onchange="processDiscData()" class="flex-grow p-3 border border-orange-200 rounded-lg bg-white text-gray-800 shadow-sm focus:ring-2 focus:ring-orange-400 outline-none font-medium">
                            <option value="" disabled selected>Click ch·ªçn t·ª´ kh√≥a...</option>
                         </select>
                         <button onclick="clearDiscTopicFilter()" class="px-3 py-2 bg-red-50 hover:bg-red-100 text-red-400 hover:text-red-600 rounded-lg border border-red-100 font-bold transition flex-shrink-0" title="X√≥a l·ª±a ch·ªçn">‚úï</button>
                       </div>
                    </div>

                    <!-- Total Count Display -->
                    <div class="mt-auto pt-4 border-t border-blue-200">
                        <p class="text-sm text-gray-500">T·ªïng s·ªë b√†i test t√¨m th·∫•y:</p>
                        <p id="disc-overview-total-count" class="text-4xl font-extrabold text-deepBlue">0</p>
                    </div>
                </div>

                <!-- Column 2: Current Chart -->
                <div class="flex flex-col items-center justify-center p-4 border border-gray-100 rounded-xl shadow-sm bg-white">
                   <h4 class="text-lg font-bold text-gray-600 mb-4 uppercase text-center">T√≠nh c√°ch hi·ªán t·∫°i (Current)</h4>
                   <div class="relative w-full aspect-square max-w-[250px]">
                      <canvas id="chart-pie-current"></canvas>
                   </div>
                </div>

                <!-- Column 3: Trend Chart -->
                <div class="flex flex-col items-center justify-center p-4 border border-gray-100 rounded-xl shadow-sm bg-white">
                   <h4 class="text-lg font-bold text-gray-600 mb-4 uppercase text-center">Xu h∆∞·ªõng h√†nh vi (Trend)</h4>
                   <div class="relative w-full aspect-square max-w-[250px]">
                      <canvas id="chart-pie-trend"></canvas>
                   </div>
                </div>
             </div>
           </div>

           <!-- Detailed Analysis -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-l-4 border-highlight">
                <h3 class="text-2xl font-bold text-highlight mb-6 flex items-center gap-2 border-b-2 border-highlight pb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    Ph√¢n t√≠ch theo t·ª´ng c√° nh√¢n
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="h-full border-r border-gray-100 pr-0 lg:pr-4">
                        <h4 class="font-bold text-gray-700 mb-2">Ch·ªçn nh√¢n s·ª± so s√°nh</h4>
                        <div class="flex gap-2 mb-4">
                            <input list="disc-candidates-list" id="disc-search-input" class="w-full p-2 border rounded text-sm bg-white" placeholder="Nh·∫≠p t√™n nh√¢n s·ª±...">
                            <datalist id="disc-candidates-list"></datalist>
                            <button onclick="addPersonToAnalysis()" class="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700">+</button>
                        </div>
                        <div class="overflow-x-auto max-h-[400px]">
                            <table class="w-full text-xs text-left">
                                <thead class="bg-gray-100 font-bold text-gray-600 sticky top-0"><tr><th class="p-2">Name / Pos</th><th class="p-2">DISC</th><th class="p-2 text-center">Show</th></tr></thead>
                                <tbody id="disc-analysis-table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="flex flex-col bg-white rounded-lg p-2 shadow-sm border border-gray-100 h-auto">
                        <h4 class="font-bold text-deepBlue text-center mb-1 uppercase">T√≠nh c√°ch hi·ªán t·∫°i (Current)</h4>
                        <div id="legend-current" class="flex flex-wrap gap-2 justify-center mb-4 transition-all duration-300 ease-in-out"></div>
                        <div class="w-full h-[450px] relative"><canvas id="admin-disc-chart-least" class="w-full h-full"></canvas></div>
                    </div>
                    <div class="flex flex-col bg-white rounded-lg p-2 shadow-sm border border-gray-100 h-auto">
                        <h4 class="font-bold text-highlight text-center mb-1 uppercase">Xu h∆∞·ªõng d·ªãch chuy·ªÉn (Trend)</h4>
                        <div id="legend-trend" class="flex flex-wrap gap-2 justify-center mb-4 transition-all duration-300 ease-in-out"></div>
                        <div class="w-full h-[450px] relative"><canvas id="admin-disc-chart-most" class="w-full h-full"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- DISC Conversion Analysis Over Time -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-l-4 border-indigo-600 mt-8">
                <h3 class="text-2xl font-bold text-indigo-700 mb-6 flex items-center gap-2 border-b-2 border-indigo-200 pb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Ph√¢n t√≠ch chuy·ªÉn ƒë·ªïi DISC theo th·ªùi gian
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Column 1: Controls -->
                    <div class="h-full border-r border-gray-100 pr-0 lg:pr-4">
                        <h4 class="font-bold text-gray-700 mb-2">1. Ch·ªçn Nh√¢n s·ª±</h4>
                        <select id="disc-time-employee-select" onchange="handleDiscTimeEmployeeChange()" class="w-full p-2 border border-indigo-300 rounded text-sm bg-white mb-4 focus:ring-2 focus:ring-indigo-300 outline-none">
                            <option value="" disabled selected>-- Ch·ªçn nh√¢n vi√™n --</option>
                        </select>

                        <h4 class="font-bold text-gray-700 mb-2">2. Ch·ªçn K·ª≥ Test (Occasion)</h4>
                        <div class="flex gap-2 mb-4">
                            <input list="disc-time-tests-list" id="disc-time-search-input" class="w-full p-2 border rounded text-sm bg-white" placeholder="Ch·ªçn Occasion + Position...">
                            <datalist id="disc-time-tests-list"></datalist>
                            <button onclick="addTestToTimeAnalysis()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700">+</button>
                        </div>
                        
                        <div class="overflow-x-auto max-h-[400px]">
                            <table class="w-full text-xs text-left">
                                <thead class="bg-gray-100 font-bold text-gray-600 sticky top-0"><tr><th class="p-2">Occasion / Pos</th><th class="p-2">DISC</th><th class="p-2 text-center">Show</th></tr></thead>
                                <tbody id="disc-time-table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Column 2: Current Chart -->
                    <div class="flex flex-col bg-white rounded-lg p-2 shadow-sm border border-gray-100 h-auto">
                        <h4 class="font-bold text-deepBlue text-center mb-1 uppercase">T√≠nh c√°ch hi·ªán t·∫°i (Current)</h4>
                        <div id="legend-time-current" class="flex flex-wrap gap-2 justify-center mb-4 transition-all duration-300 ease-in-out"></div>
                        <div class="w-full h-[450px] relative"><canvas id="disc-time-chart-least" class="w-full h-full"></canvas></div>
                    </div>

                    <!-- Column 3: Trend Chart -->
                    <div class="flex flex-col bg-white rounded-lg p-2 shadow-sm border border-gray-100 h-auto">
                        <h4 class="font-bold text-highlight text-center mb-1 uppercase">Xu h∆∞·ªõng d·ªãch chuy·ªÉn (Trend)</h4>
                        <div id="legend-time-trend" class="flex flex-wrap gap-2 justify-center mb-4 transition-all duration-300 ease-in-out"></div>
                        <div class="w-full h-[450px] relative"><canvas id="disc-time-chart-most" class="w-full h-full"></canvas></div>
                    </div>
                </div>
            </div>
            
            <!-- Culture Fit Analysis -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-l-4 border-purple-600 mt-8 hidden">
                <h3 class="text-2xl font-bold text-purple-700 mb-6 flex items-center gap-2 border-b-2 border-purple-200 pb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    Ph√¢n t√≠ch ph√π h·ª£p v·ªõi VƒÉn h√≥a
                </h3>
                <div class="mb-4 flex flex-col md:flex-row gap-2 items-end md:items-center">
                    <div class="flex-grow w-full md:w-auto">
                        <div class="flex gap-2">
                            <input list="disc-culture-candidates-list" id="disc-culture-search-input" class="w-full p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-purple-300 outline-none" placeholder="Nh·∫≠p t√™n nh√¢n s·ª±...">
                            <datalist id="disc-culture-candidates-list"></datalist>
                            <button onclick="addPersonToCultureAnalysis()" class="bg-purple-600 text-white px-6 py-2 rounded font-bold hover:bg-purple-700 shadow transition flex-shrink-0">Th√™m</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse border border-gray-200">
                        <thead class="bg-gray-100 text-purple-900 uppercase text-xs font-bold">
                            <tr>
                                <th class="p-3 border border-gray-300 w-1/12 text-center">Name</th>
                                <th class="p-3 border border-gray-300 w-1/12 text-center">Position</th>
                                <th class="p-3 border border-gray-300 w-1/12 text-center">C-DISC</th>
                                <th class="p-3 border border-gray-300 w-1/12 text-center">T-DISC</th>
                                <th class="p-3 border border-gray-300 w-1/4 text-green-700 bg-green-50 text-center">Most-Fit Culture</th>
                                <th class="p-3 border border-gray-300 w-1/4 text-yellow-700 bg-yellow-50 text-center">Least-Fit Culture</th>
                                <th class="p-3 border border-gray-300 w-1/4 text-red-700 bg-red-50 text-center">Most-NonFit Culture</th>
                            </tr>
                        </thead>
                        <tbody id="disc-culture-table-body" class="divide-y divide-gray-200 bg-white">
                            <!-- Rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
      </div>
    </div>

    <!-- VIEW 3: QUIZ CONTAINER -->
    <div id="view-quiz" class="view-section hidden">
      <!-- 3.1: ENTRY FORM -->
      <div id="quiz-entry-form" class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg mt-10 border-t-4 border-deepBlue">
        <div class="text-center mb-8">
          <h2 class="text-[26px] font-bold text-deepBlue uppercase">Th√¥ng tin th√≠ sinh</h2>
          <p class="mt-4"><span class="font-bold text-green-600 text-xl">Assessment: </span><span id="entry-quiz-title" class="font-bold text-green-600 text-xl">...</span></p>
        </div>
        <div class="space-y-6">
          <div>
            <label class="block text-xl font-bold text-deepBlue mb-2">T√™n - Nickname <span class="text-red-500">*</span></label>
            <input type="text" id="candidate-name" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-deepBlue focus:outline-none bg-gray-50 text-lg" placeholder="Ms Th·∫£o - Tracy" onkeypress="if(event.key === 'Enter') handleStartActualQuiz()">
            <span id="error-name" class="hidden text-red-500 text-xs animate-pulse-fast font-bold ml-1 pt-1 block">‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn T√™n/Nickname</span>
          </div>
          <div>
            <select id="candidate-position" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-deepBlue focus:outline-none bg-gray-50 text-lg">
                <option value="" disabled selected>-- Ch·ªçn ch·ª©c danh * --</option>
                <option value="" disabled>ƒêang t·∫£i danh s√°ch...</option>
            </select>
            <span id="error-position" class="hidden text-red-500 text-xs animate-pulse-fast font-bold ml-1 pt-1 block">‚ö†Ô∏è Vui l√≤ng ch·ªçn Ch·ª©c danh</span>
          </div>
          <div class="pt-4">
             <div class="flex flex-col-reverse md:flex-row gap-4">
                 <button onclick="returnToHome()" class="md:w-1/3 w-full bg-gray-200 hover:bg-green-600 hover:text-white text-gray-600 font-bold text-lg py-4 rounded-lg shadow transition">Quay l·∫°i</button>
                 <button onclick="handleStartActualQuiz()" class="md:w-2/3 w-full bg-highlight hover:bg-orange-600 text-white hover:text-deepBlue font-bold text-xl py-4 rounded-lg shadow-lg transition transform hover:-translate-y-1">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
             </div>
            <p class="text-center text-base text-green-600 mt-4 italic font-medium">L∆∞u √Ω: Th·ªùi gian s·∫Ω b·∫Øt ƒë·∫ßu t√≠nh ngay khi b·∫°n nh·∫•n n√∫t n√†y.</p>
          </div>
        </div>
      </div>

      <!-- 3.2: QUIZ INTERFACE -->
      <div id="quiz-interface" class="flex flex-col lg:flex-row gap-6 max-w-7xl mx-auto hidden">
        <aside class="lg:w-1/4">
          <div class="bg-white p-6 rounded-xl shadow-lg sticky top-24 border-t-4 border-deepBlue">
            <div class="text-center mb-4">
              <span class="text-green-600 text-xl uppercase font-bold">Th·ªùi gian c√≤n l·∫°i</span>
              <div id="timer-display" class="text-4xl font-mono font-bold text-highlight mt-1 transition-transform duration-200 origin-center">00:00</div>
            </div>
            <hr class="my-4 border-gray-200">
            <div class="mb-4">
              <h4 class="text-xl font-bold text-deepBlue uppercase mb-2">Danh s√°ch c√¢u h·ªèi <span id="progress-display" class="text-base text-highlight ml-1"></span></h4>
              <div class="flex gap-2 mb-3 text-[10px] font-bold"><div class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-400 rounded-sm"></span> Ch∆∞a l√†m</div><div class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-sm"></span> ƒê√£ l√†m</div></div>
              <div id="question-nav-grid" class="grid grid-cols-5 gap-2"></div>
            </div>
            <hr class="my-4 border-gray-200">
            <div class="mb-2"><span class="block text-xs text-gray-400">ƒê·ªÅ thi</span><span id="quiz-title-display" class="font-semibold text-deepBlue truncate block">...</span></div>
            <div class="mb-2"><span class="block text-xs text-gray-400">Th√≠ sinh</span><span id="display-candidate-name" class="font-semibold text-gray-800 truncate block">...</span></div>
            <button type="button" onclick="submitQuiz()" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow">N·ªôp b√†i</button>
          </div>
        </aside>
        <div class="lg:w-3/4">
          <div id="questions-container" class="min-h-[500px]"></div>
          <div class="flex justify-between mt-6 px-4">
             <button onclick="changeBlock(-1)" class="text-gray-500 hover:text-deepBlue font-bold" id="btn-prev-block">‚Üê Tr∆∞·ªõc</button>
             <button onclick="changeBlock(1)" class="text-gray-500 hover:text-deepBlue font-bold" id="btn-next-block">Sau ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- 3.3: DISC INTERFACE -->
      <div id="disc-interface" class="max-w-7xl mx-auto hidden">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-lg shadow-sm mb-6">
            <h3 class="text-2xl md:text-3xl font-bold text-deepBlue mb-3 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                H∆∞·ªõng d·∫´n l√†m b√†i test
            </h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-700 text-lg md:text-xl leading-snug">
                <li>H√¨nh dung b·ªëi c·∫£nh khi ch·ªçn c√¢u tr·∫£ l·ªùi l√† ƒëang <b>‚Äú·ªû n∆°i l√†m vi·ªác‚Äù</b> cho b√†i test n√†y.</li>
                <li>ƒê·ªçc k·ªπ c√°c c·ª•m t·ª´ m√¥ t·∫£ t√≠nh c√°ch ·ªü m·ªói c√¢u h·ªèi ƒë·ªÉ Ch·ªçn m·ªôt trong 02 ph∆∞∆°ng √°n <b>‚ÄúGi·ªëng t√¥i nh·∫•t‚Äù</b> ho·∫∑c <b>‚Äú√çt gi·ªëng t√¥i nh·∫•t‚Äù</b>.</li>
                <li>·ª®ng v·ªõi m·ªói block, ch·ªâ ch·ªçn <b>M·ªòT c√¢u tr·∫£ l·ªùi</b> ‚ÄúGi·ªëng t√¥i nh·∫•t‚Äù v√† <b>M·ªòT c√¢u tr·∫£ l·ªùi</b> ‚Äú√çt gi·ªëng t√¥i nh·∫•t‚Äù.</li>
                <li>ƒê·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c, <span class="font-bold text-red-600">To√†n b·ªô b√†i test n√†y ch·ªâ n√™n ho√†n t·∫•t trong v√≤ng 7 PH√öT, ho·∫∑c c√†ng nhanh c√†ng t·ªët.</span></li>
            </ul>
        </div>
        <div class="flex flex-col lg:flex-row gap-6">
            <aside class="lg:w-1/4">
                <div class="bg-white p-6 rounded-xl shadow-lg sticky top-24 border-t-4 border-highlight flex flex-col items-center justify-center text-center">
                    <div class="text-center mb-4"><span class="text-highlight text-xl md:text-2xl uppercase font-bold">DISC Answer Sheet</span><div id="disc-name-display" class="text-2xl font-bold text-gray-800 mt-2 break-words">--</div></div>
                    <hr class="my-4 border-gray-200 w-full">
                    <div class="mb-4"><span class="text-lg font-bold text-highlight uppercase block">Th·ªùi gian th·ª±c hi·ªán</span><div id="disc-main-timer" class="text-4xl md:text-5xl font-mono font-bold text-deepBlue origin-center transition-transform">00:00</div></div>
                </div>
            </aside>
            <div class="lg:w-3/4 border-t-4 border-highlight pt-6 relative">
                <div class="absolute -top-1.5 -right-1 w-3 h-3 bg-orange-500 rounded-full"></div>
                <div class="flex justify-end items-center mb-2 gap-2"><span class="text-lg font-bold text-blue-600">H√£y ch·ªçn nhanh:</span><div id="disc-block-timer" class="text-2xl font-mono font-bold text-highlight origin-center transition-transform">00:00</div></div>
                <div class="mb-4">
                    <div class="flex justify-between text-base text-blue-600 font-bold mb-1"><span>Ti·∫øn ƒë·ªô</span><span id="disc-progress-text">1/24</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-4"><div id="disc-progress-bar" class="bg-highlight h-4 rounded-full transition-all duration-300" style="width: 4%"></div></div>
                </div>
                <div id="disc-questions-container" class="space-y-6"></div>
                <div class="mt-4 px-4">
                    <div id="disc-error-msg" class="hidden text-red-600 font-bold text-sm text-right mb-2 animate-pulse">Vui l√≤ng ch·ªçn ƒë·ªß 1 "Gi·ªëng t√¥i nh·∫•t" v√† 1 "Kh√°c t√¥i nh·∫•t"</div>
                    <div class="flex justify-between items-center">
                        <button onclick="changeDiscBlock(-1)" id="btn-disc-prev" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg shadow disabled:opacity-50 transition">‚Üê Block Tr∆∞·ªõc</button>
                        <div class="flex-grow"></div>
                        <button onclick="changeDiscBlock(1)" id="btn-disc-next" class="bg-highlight hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow disabled:opacity-50 transition">Ti·∫øp t·ª•c</button>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
    
    <!-- Rest of VIEWs (Result, DISC Result) remain unchanged in structure -->
    <!-- VIEW 4: RESULT -->
    <div id="view-result" class="view-section hidden">
      <div class="max-w-7xl mx-auto">
        <div class="flex flex-col lg:flex-row gap-8">
          <div class="w-full lg:w-2/3">
            <div class="bg-white p-5 rounded-2xl shadow-xl text-center border-t-8 border-green-500 mb-5">
              <div class="w-14 h-14 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-2 text-2xl">‚úì</div>
              <h2 class="text-3xl font-bold text-highlight uppercase">Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i thi!</h2>
              <div class="mt-2 mb-2"><h3 id="result-candidate-name" class="text-3xl font-bold text-deepBlue leading-tight">...</h3><p id="result-candidate-position" class="text-xs text-gray-500 font-medium mt-1 uppercase tracking-wide">...</p></div>
              <div class="mt-2 p-3 bg-gray-50 rounded-lg inline-block min-w-[200px]"><span class="block text-base text-green-600 uppercase tracking-widest font-bold">Total Score</span><span id="final-score-display" class="block text-4xl font-extrabold text-deepBlue mt-1">--</span></div>
              <div class="mt-1 text-xs text-gray-500"><span>S·ªë g·ª£i √Ω ƒë√£ d√πng: </span><span id="final-hints-display" class="font-bold text-orange-600">0</span></div>
              <div class="mt-4"><button onclick="returnToHome()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition transform hover:-translate-y-0.5 text-sm">V·ªÅ trang ch·ªß</button></div>
            </div>
            <div class="flex justify-center mb-8"><button onclick="scrollToLiveFeed()" class="group flex items-center gap-2 px-5 py-2 bg-white border border-blue-200 rounded-full shadow-sm hover:shadow-md hover:border-blue-400 transition cursor-pointer text-blue-600"><span class="font-bold text-sm group-hover:underline">Xem Danh s√°ch th√≠ sinh n·ªôp b√†i T·∫†I ƒê√ÇY</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg></button></div>
            <div class="flex items-center gap-3 mb-6 mt-2 border-b-2 border-gray-100 pb-2"><div class="w-1.5 h-8 bg-highlight rounded-full"></div><h3 class="text-2xl font-extrabold text-highlight uppercase tracking-wide">Xem l·∫°i b√†i ƒë√£ n·ªôp T·∫†I ƒê√ÇY</h3></div>
            <div id="result-map-container" class="mb-6 flex flex-col items-center w-full">
                <div id="result-map-grid" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-3 w-full max-w-4xl p-4"></div>
                <div class="flex flex-wrap justify-center gap-4 mt-6 text-sm font-bold items-center"><div class="flex items-center gap-2"><span class="w-4 h-4 bg-green-500 rounded-full ring-2 ring-green-200"></span> ƒê√∫ng</div><div class="flex items-center gap-2"><span class="w-4 h-4 bg-red-500 rounded-full ring-2 ring-red-200"></span> Sai</div><span class="text-blue-600 font-bold ml-2 italic text-base">(Click v√†o ƒë·ªÉ xem chi ti·∫øt)</span></div>
            </div>
            <div id="result-detail-viewer" class="transition-all duration-300"></div>
            <div class="h-20"></div>
          </div>
          <div class="w-full lg:w-1/3" id="live-feed-container">
            <div class="sticky top-24">
              <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                <div class="bg-deepBlue p-4 flex flex-col justify-between">
                  <div class="flex items-center justify-between mb-1"><h3 class="text-white font-bold flex items-center gap-2 text-sm"><span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span> Danh s√°ch th√≠ sinh n·ªôp b√†i...</h3><span class="text-xs text-yellow-400 font-bold animate-pulse">C·∫≠p nh·∫≠t realtime</span></div>
                  <div id="live-feed-score-pass" class="text-blue-200 text-xs italic text-right mt-1 border-t border-blue-800 pt-1">ƒêi·ªÉm chu·∫©n: --</div>
                </div>
                <div class="p-2 bg-gray-50"><div id="live-feed-list" class="space-y-2 max-h-[500px] overflow-y-auto pr-1"><div class="text-center text-gray-400 py-4 text-sm italic">ƒêang t·∫£i d·ªØ li·ªáu...</div></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW 5: DISC RESULT (Previously Modal) -->
    <div id="view-disc-result" class="view-section hidden">
      <div class="max-w-7xl mx-auto py-10 px-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 border-t-4 border-green-500 animate-slide-up-fade">
            <!-- Header -->
            <div class="flex flex-col items-center justify-center text-center mb-8">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
                </div>
                <h3 class="text-4xl md:text-5xl font-extrabold text-green-600 mb-2">K·∫øt qu·∫£ DISC</h3>
                <p id="disc-result-subtitle" class="text-xl md:text-2xl text-deepBlue font-bold">...</p>
            </div>
            
            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Graph II -->
                <div class="flex flex-col items-center bg-gray-50 p-6 rounded-xl border border-gray-100 shadow-sm">
                    <h4 id="title-graph-least" class="text-xl font-bold text-deepBlue mb-2 uppercase border-b-2 border-deepBlue pb-1">T√≠nh c√°ch hi·ªán t·∫°i</h4>
                    <p id="subtitle-graph-least" class="text-xl text-deepBlue mb-4 font-bold h-6 flex items-center justify-center w-full text-center">...</p>
                    <div class="w-full bg-white p-2 rounded shadow-sm">
                         <canvas id="disc-chart-least" class="w-full h-auto" style="min-height: 400px; max-height: 500px;"></canvas>
                    </div>
                </div>
                <!-- Graph III -->
                <div class="flex flex-col items-center bg-gray-50 p-6 rounded-xl border border-gray-100 shadow-sm">
                    <h4 id="title-graph-most" class="text-xl font-bold text-highlight mb-2 uppercase border-b-2 border-highlight pb-1">Xu h∆∞·ªõng d·ªãch chuy·ªÉn</h4>
                    <p id="subtitle-graph-most" class="text-xl text-highlight mb-4 font-bold h-6 flex items-center justify-center w-full text-center">...</p>
                    <div class="w-full bg-white p-2 rounded shadow-sm">
                         <canvas id="disc-chart-most" class="w-full h-auto" style="min-height: 400px; max-height: 500px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- New Image Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <img src="https://lh3.googleusercontent.com/d/1iJfaaHouWEn0fvO-c2zJyjPbRmhGIGvt" referrerpolicy="no-referrer" alt="Image 1" class="w-full h-auto rounded object-cover">
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <img src="https://lh3.googleusercontent.com/d/1LXgEK_wl9_93fEVIsVdqNaelIQ8CZhtX" referrerpolicy="no-referrer" alt="Image 2" class="w-full h-auto rounded object-cover">
                </div>
            </div>

            <!-- Footer -->
            <div class="flex justify-center mt-8">
                <button onclick="returnToHome()" class="px-10 py-4 rounded-full bg-deepBlue text-white font-bold text-lg hover:bg-blue-800 shadow-xl transition-all duration-300 transform hover:-translate-y-1 focus:outline-none flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    Quay v·ªÅ trang ch·ªß
                </button>
            </div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // URL Backend Google Apps Script
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyPprsM3muwgYFLVmeRAjOS5rcYnJ1LxnUpVm0yuVNejw679uWOnO_9I6Lfi-gbFhj_aw/exec";

    // --- GRAPH MAPPINGS & VARIABLES ---
    const GRAPH_II_MAPPING = [
      { "id": 0, "D": 0, "I": 0, "S": 0, "C": 0 },
      { "id": 1, "D": 1, "I": null, "S": 1, "C": 1 },
      { "id": 2, "D": null, "I": 1, "S": 2, "C": null },
      { "id": 3, "D": 2, "I": null, "S": null, "C": 2 },
      { "id": 4, "D": null, "I": 2, "S": 3, "C": 3 },
      { "id": 5, "D": 3, "I": 3, "S": 4, "C": 4 },
      { "id": 6, "D": 4, "I": null, "S": 5, "C": 5 },
      { "id": 7, "D": 5, "I": 4, "S": 6, "C": 6 },
      { "id": 8, "D": 6, "I": 5, "S": 7, "C": 7 },
      { "id": 9, "D": 7, "I": 6, "S": null, "C": null },
      { "id": 10, "D": 8, "I": null, "S": 8, "C": 8 },
      { "id": 11, "D": 9, "I": 7, "S": null, "C": 9 },
      { "id": 12, "D": 10, "I": 8, "S": 9, "C": null },
      { "id": 13, "D": 11, "I": null, "S": null, "C": null },
      { "id": 14, "D": 12, "I": 9, "S": 10, "C": 10 },
      { "id": 15, "D": 13, "I": 10, "S": 11, "C": 11 },
      { "id": 16, "D": 14, "I": 11, "S": null, "C": null },
      { "id": 17, "D": 15, "I": null, "S": 12, "C": 12 },
      { "id": 18, "D": 16, "I": 15, "S": 13, "C": 13 },
      { "id": 19, "D": 21, "I": 19, "S": 19, "C": 16 }
    ];
    const GRAPH_III_MAPPING = [
      { "id": 0, "D": 20, "I": 17, "S": 19, "C": 15 },
      { "id": 1, "D": 16, "I": null, "S": 12, "C": 9 },
      { "id": 2, "D": 15, "I": 10, "S": 11, "C": 8 },
      { "id": 3, "D": 14, "I": 9, "S": null, "C": 7 },
      { "id": 4, "D": 13, "I": 8, "S": 10, "C": null },
      { "id": 5, "D": 12, "I": null, "S": null, "C": null },
      { "id": 6, "D": 11, "I": 7, "S": 9, "C": 6 },
      { "id": 7, "D": 10, "I": null, "S": 8, "C": null },
      { "id": 8, "D": 9, "I": null, "S": null, "C": null },
      { "id": 9, "D": null, "I": 6, "S": 7, "C": 5 },
      { "id": 10, "D": 8, "I": null, "S": null, "C": null },
      { "id": 11, "D": null, "I": 5, "S": 6, "C": null },
      { "id": 12, "D": 7, "I": null, "S": 5, "C": 4 },
      { "id": 13, "D": null, "I": 4, "S": null, "C": null },
      { "id": 14, "D": 6, "I": null, "S": 4, "C": 3 },
      { "id": 15, "D": 5, "I": 3, "S": 3, "C": null },
      { "id": 16, "D": 4, "I": null, "S": null, "C": 2 },
      { "id": 17, "D": 3, "I": 2, "S": 2, "C": null },
      { "id": 18, "D": 2, "I": null, "S": 1, "C": null },
      { "id": 19, "D": null, "I": 1, "S": null, "C": 1 },
      { "id": 20, "D": 1, "I": null, "S": 0, "C": null },
      { "id": 21, "D": 0, "I": 0, "S": null, "C": 0 }
    ];

    let allQuestions = [];
    let currentTestName = "";
    let currentTestType = "QUIZ";
    let currentTestDept = ""; 
    let currentTestArea = "";
    let currentTestOccasion = ""; // NEW
    let currentTestStartTime = ""; // NEW
    let currentDiscConfig = null;
    let timerInterval = null;
    let pollingInterval = null;
    let adminPollingInterval = null;
    let chartBlinkInterval = null;
    let quizTimeRemaining = 0;
    let totalDuration = 0;
    let currentPassScore = 0;
    let displayedFeedJSON = "";
    let resultsChart = null;
    let currentHintsUsed = 0;
    
    // ADMIN STATE
    let allTestsData = [];
    let currentUserRole = "";
    let currentUserDept = "";
    let currentUserArea = "";

    let currentBlockIndex = 0;
    const QUESTIONS_PER_BLOCK = 4;
    let totalBlocks = 0;

    // DISC STATE
    let discQuestions = [];
    let currentDiscBlockIndex = 0;
    const DISC_QUESTIONS_PER_BLOCK = 4;
    let totalDiscBlocks = 24;
    let discMainTimeRemaining = 0;
    let discBlockTimeRemaining = 0;
    let discBlockDurationConfig = 0;
    let discMainInterval = null;
    let discBlockInterval = null;
    let discSelections = {};
    
    // DISC CULTURE FIT VARIABLES
    let strMostFit = "";
    let strLeastFit = "";
    let strMostNonFit = "";
    
    // DISC ADMIN STATE
    let discRawData = [];
    let discFilteredData = [];
    let discAllResultsGlobal = []; // ADDED
    let discSelectedCandidates = []; 
    let discCultureSelectedCandidates = []; // New state for culture analysis
    
    // New variables for DISC Conversion Analysis Over Time
    let discTimeSelectedTests = [];
    let discTimeAvailableTests = [];
    
    let discPieCurrent = null;
    let discPieTrend = null;
    
    // New variables for totals
    let discTotalFit = 0;
    let discTotalNonFit = 0;

    let currentResultDetails = [];
    let currentResultIndex = 0;

    function runBackend(funcName, ...args) {
      const isProduction = typeof google !== 'undefined' && google.script && google.script.run;
      if (isProduction) {
        const runner = google.script.run.withFailureHandler(handleError);
        switch(funcName) {
          case 'getTestsList': runner.withSuccessHandler(populateTestDropdowns).getTestsList(); break;
          case 'validateAdmin': runner.withSuccessHandler(res => {
            toggleLoading(false); 
            if(res && res.valid) { setupAdminDashboard(res.permissions, res.department, res.role, res.area); showView('view-admin'); } else alert('Sai th√¥ng tin ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p');
          }).validateAdmin(...args); break;
          case 'getTestResults': runner.withSuccessHandler(renderAdminDashboard).getTestResults(...args); break;
          case 'getQuizData': runner.withSuccessHandler(setupQuiz).getQuizData(...args); break;
          case 'submitQuiz': runner.withSuccessHandler(showResult).submitQuiz(...args); break;
          case 'getRecentResults': runner.withSuccessHandler(updateLiveFeed).getRecentResults(...args); break;
          case 'getDiscTestConfig': runner.withSuccessHandler(setupDiscEntry).getDiscTestConfig(...args); break;
          case 'getDiscQuestions': runner.withSuccessHandler(setupDiscInterface).getDiscQuestions(...args); break;
          case 'submitDiscTest': runner.withSuccessHandler(showDiscResult).submitDiscTest(...args); break;
          case 'getDiscResultsForAdmin': runner.withSuccessHandler(initDiscAdmin).getDiscResultsForAdmin(...args); break;
          case 'getRoleList': runner.withSuccessHandler(populateRoleDropdown).getRoleList(); break;
        }
      } else {
        if (!GAS_API_URL || GAS_API_URL.includes("D√ÅN_URL")) { toggleLoading(false); alert("CH∆ØA C·∫§U H√åNH URL!"); return; }
        const payload = { action: funcName, args: args };
        fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(response => response.json())
        .then(json => {
          if (json.status === 'error') throw new Error(json.message);
          const res = json.data;
          if(funcName === 'getTestsList') populateTestDropdowns(res);
          if(funcName === 'validateAdmin') {
             toggleLoading(false); 
             if(res && res.valid) { setupAdminDashboard(res.permissions, res.department, res.role, res.area); showView('view-admin'); } else alert('Sai th√¥ng tin');
          }
          if(funcName === 'getTestResults') renderAdminDashboard(res);
          if(funcName === 'getQuizData') setupQuiz(res);
          if(funcName === 'submitQuiz') showResult(res);
          if(funcName === 'getRecentResults') updateLiveFeed(res);
          if(funcName === 'getDiscTestConfig') setupDiscEntry(res);
          if(funcName === 'getDiscQuestions') setupDiscInterface(res);
          if(funcName === 'submitDiscTest') showDiscResult(res);
          if(funcName === 'getDiscResultsForAdmin') initDiscAdmin(res); 
          if(funcName === 'getRoleList') populateRoleDropdown(res);
        })
        .catch(err => { if (funcName !== 'getRecentResults') handleError(err); });
      }
    }

    window.onload = () => { 
      if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);
      toggleLoading(true); 
      runBackend('getTestsList'); 
      runBackend('getRoleList');
    };

    function populateTestDropdowns(tests) {
      toggleLoading(false);
      
      // Store raw data for later filtering
      allTestsData = tests || [];
      
      const s = document.getElementById('student-test-select');
      // We do not populate Admin dropdown here anymore, we do it after login via filterAdminTests()
      
      s.innerHTML = '<option value="" disabled selected>Get started here...</option>';
      
      if(!tests || !tests.length) {
         s.innerHTML = '<option disabled>Kh√¥ng c√≥ d·ªØ li·ªáu (Ki·ªÉm tra k·∫øt n·ªëi)</option>';
         return;
      }
      
      // Populate Student Dropdown (Only Active)
      tests.forEach(t => {
        const isActive = t.status && t.status.toLowerCase() === 'active';
        if (isActive) {
           // Format: For Area + Test Name + Department + Occasion Test + Start Time
           const areaStr = t.forArea ? `[${t.forArea}] ` : '';
           const deptStr = t.department ? ` + ${t.department}` : '';
           const occasionStr = t.occasion ? ` + ${t.occasion}` : '';
           const timeStr = t.startTime ? ` + ${t.startTime}` : '';
           const display = `${areaStr}${t.name}${deptStr}${occasionStr}${timeStr}`;
           
           // Inject specific details into data attributes so we can retrieve them exactly later
           const optStudent = `<option value="${t.name}" 
               data-type="${t.type}"
               data-department="${t.department || ''}"
               data-area="${t.forArea || ''}"
               data-occasion="${t.occasion || ''}"
               data-starttime="${t.startTime || ''}"
           >${display}</option>`;
           s.insertAdjacentHTML('beforeend', optStudent);
        }
      });
      
      // If user is already logged in (re-fetch scenario), refresh admin list
      if (!document.getElementById('view-admin').classList.contains('hidden')) {
          filterAdminTests();
      }
    }
    
    function populateRoleDropdown(roles) {
      const select = document.getElementById('candidate-position');
      if(!select) return;
      let html = '<option value="" disabled selected>-- Ch·ªçn ch·ª©c danh * --</option>';
      if (roles && roles.length > 0) {
        roles.forEach(r => {
          html += `<option value="${r}">${r}</option>`;
        });
      } else {
        html += '<option value="" disabled>Kh√¥ng c√≥ d·ªØ li·ªáu</option>';
      }
      select.innerHTML = html;
    }

    function showView(id) {
      document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      window.scrollTo(0,0);
      if (id !== 'view-result' && pollingInterval) clearInterval(pollingInterval);
      if (id !== 'view-admin' && adminPollingInterval) clearInterval(adminPollingInterval);
      if (id !== 'view-admin' && chartBlinkInterval) clearInterval(chartBlinkInterval);
      if (id !== 'disc-interface') {
        if (discMainInterval) clearInterval(discMainInterval);
        if (discBlockInterval) clearInterval(discBlockInterval);
      }
    }
    
    function toggleLoading(show, txt="ƒêang x·ª≠ l√Ω...") {
      document.getElementById('loading-text').innerText = txt;
      document.getElementById('loading-overlay').classList.toggle('hidden', !show);
    }
    function handleError(e) { toggleLoading(false); alert('L·ªói: ' + e.message); }
    function handleAdminLogin() {
      const u = document.getElementById('admin-user').value;
      const p = document.getElementById('admin-pass').value;
      if(u && p) { toggleLoading(true); runBackend('validateAdmin', u.trim(), p.trim()); }
    }
    function toggleAdminLogin() { document.getElementById('admin-login-form').classList.toggle('hidden'); }
    function exitAdminView() {
      if(adminPollingInterval) clearInterval(adminPollingInterval);
      if(chartBlinkInterval) clearInterval(chartBlinkInterval);
      showView('view-home');
      // Reset state
      currentUserRole = ""; currentUserDept = ""; currentUserArea = "";
    }

    function setupAdminDashboard(perms, dept, role, area) {
        currentUserDept = dept || "";
        currentUserRole = role || "";
        currentUserArea = area || "";

        const btnQuiz = document.getElementById('tab-btn-quiz');
        const btnDisc = document.getElementById('tab-btn-disc');
        if (perms && perms.quiz) btnQuiz.classList.remove('hidden'); else btnQuiz.classList.add('hidden');
        if (perms && perms.disc) btnDisc.classList.remove('hidden'); else btnDisc.classList.add('hidden');
        
        // Setup Badges
        const deptBadge = document.getElementById('admin-dept-badge');
        const deptText = document.getElementById('admin-dept-text');
        if (dept) { deptText.innerText = dept; deptBadge.classList.remove('hidden'); } else deptBadge.classList.add('hidden');

        const roleBadge = document.getElementById('admin-role-badge');
        const roleText = document.getElementById('admin-role-text');
        if (role) { roleText.innerText = role; roleBadge.classList.remove('hidden'); } else roleBadge.classList.add('hidden');

        const areaBadge = document.getElementById('admin-area-badge');
        const areaText = document.getElementById('admin-area-text');
        if (area) { areaText.innerText = area; areaBadge.classList.remove('hidden'); } else areaBadge.classList.add('hidden');
        
        // Filter tests based on new Role/Area rules
        filterAdminTests();

        if (perms && perms.quiz) switchAdminTab('quiz');
        else if (perms && perms.disc) switchAdminTab('disc');
        else { alert("T√†i kho·∫£n c·ªßa b·∫°n kh√¥ng ƒë∆∞·ª£c ph√¢n quy·ªÅn truy c·∫≠p."); showView('view-home'); }
    }

    function filterAdminTests() {
        const select = document.getElementById('admin-test-select');
        select.innerHTML = '<option value="" disabled selected>-- Ch·ªçn b√†i thi --</option>';
        
        const role = (currentUserRole || "").trim().toLowerCase();
        
        // Role Logic:
        // 1. Super Admin: Show all (No strict filter)
        // 2. Admin: Filter by Department
        // 3. QLKV: Filter by Area
        
        const isSuperAdmin = role.includes('super admin');
        const isQLKV = role.includes('qlkv');
        const isAdmin = role.includes('admin') && !isSuperAdmin;

        allTestsData.forEach(t => {
            if (t.type === 'DISC') return; // Handled in DISC tab
            
            let isVisible = false;
            
            if (isSuperAdmin) {
                isVisible = true;
            } else if (isAdmin) {
                // Admin must match Department
                if ((t.department || "").trim().toLowerCase() === (currentUserDept || "").trim().toLowerCase()) isVisible = true;
            } else if (isQLKV) {
                // QLKV: Must have a value for Area AND match the user's area
                const testArea = (t.forArea || "").trim().toLowerCase();
                const userArea = (currentUserArea || "").trim().toLowerCase();
                // Ensure testArea is not empty string before comparing
                if (testArea && testArea === userArea) isVisible = true;
            }
            
            if (isVisible) {
                const isActive = t.status && t.status.toLowerCase() === 'active';
                const suffix = isActive ? '' : ' [InActive]';
                
                // --- NEW LOGIC START ---
                let displayName = t.name;
                if (t.forArea) displayName = `[${t.forArea}] ` + displayName;
                if (t.occasion) displayName = displayName + ` - ${t.occasion}`;
                // --- NEW LOGIC END ---

                const opt = `<option value="${t.name}" data-type="${t.type}" data-occasion="${t.occasion || ''}">${displayName} (${t.duration} ph√∫t - ${t.questionCount} c√¢u)${suffix}</option>`;
                select.insertAdjacentHTML('beforeend', opt);
            }
        });
    }

    function switchAdminTab(tab) {
       const tabs = ['quiz', 'disc'];
       tabs.forEach(t => {
          const btn = document.getElementById(`tab-btn-${t}`);
          const content = document.getElementById(`tab-content-${t}`);
          if (t === tab) {
             btn.classList.add('border-highlight', 'text-highlight');
             btn.classList.remove('border-transparent', 'text-gray-400', 'hover:text-gray-600', 'hover:border-gray-300');
             content.classList.remove('hidden');
             if(tab === 'disc') {
                loadDiscAdminData();
             }
          } else {
             btn.classList.remove('border-highlight', 'text-highlight');
             btn.classList.add('border-transparent', 'text-gray-400', 'hover:text-gray-600', 'hover:border-gray-300');
             content.classList.add('hidden');
          }
       });
    }

    // --- QUIZ FUNCTIONS ---
    // (Existing Quiz functions omitted for brevity as they are unchanged)
    function loadResults() {
      const select = document.getElementById('admin-test-select');
      const v = select.value;
      const occasion = select.options[select.selectedIndex].getAttribute('data-occasion');

      if(v) { 
        toggleLoading(true, "ƒêang t·∫£i b√°o c√°o..."); 
        runBackend('getTestResults', v, occasion); 
        if(adminPollingInterval) clearInterval(adminPollingInterval);
        adminPollingInterval = setInterval(() => { runBackend('getTestResults', v, occasion); }, 10000);
      }
    }
    function renderAdminDashboard(dataWrapper) {
      toggleLoading(false);
      const passScore = Number(dataWrapper.passScore) || 0;
      const testDuration = Number(dataWrapper.duration) || 0; 
      let totalQuestions = Number(dataWrapper.totalQuestions) || 0;
      let results = dataWrapper.results || [];
      
      const role = (currentUserRole || "").trim().toLowerCase();
      const isSuperAdmin = role.includes('super admin');
      const isQLKV = role.includes('qlkv');
      const isAdmin = role.includes('admin') && !isSuperAdmin;

      if (!isSuperAdmin) {
         if (isAdmin) {
             const targetDept = (currentUserDept || "").trim().toLowerCase();
             results = results.filter(r => (r.department || "").trim().toLowerCase() === targetDept);
         } else if (isQLKV) {
             const targetArea = (currentUserArea || "").trim().toLowerCase();
             results = results.filter(r => (r.forArea || "").trim().toLowerCase() === targetArea);
         }
      }

      if (totalQuestions === 0 && results.length > 0) {
          const maxS = Math.max(...results.map(r => r.score));
          totalQuestions = maxS > 0 ? maxS : 20; 
      } else if (totalQuestions === 0) totalQuestions = 20;
      
      const contentDiv = document.getElementById('admin-dashboard-content');
      const emptyMsg = document.getElementById('admin-empty-msg');
      if (results.length === 0) {
         contentDiv.classList.add('hidden'); emptyMsg.classList.remove('hidden'); return;
      }
      contentDiv.classList.remove('hidden'); emptyMsg.classList.add('hidden');
      renderChart(results, passScore, totalQuestions);
      
      const god = [...results].sort((a,b) => (b.score !== a.score) ? b.score - a.score : b.timeSaving - a.timeSaving)[0];
      if(god) {
        document.getElementById('badge-god').classList.remove('hidden');
        document.getElementById('god-name').innerText = god.candidate;
        document.getElementById('god-desc').innerText = `ƒêi·ªÉm cao nh·∫•t: ${god.score} | Th·ªùi gian c√≤n l·∫°i nhi·ªÅu nh·∫•t: ${god.timeSaving}p`;
      } else document.getElementById('badge-god').classList.add('hidden');

      const failFast = results.filter(r => r.score < passScore).sort((a,b) => b.timeSaving - a.timeSaving)[0];
      if(failFast) {
         document.getElementById('badge-furious').classList.remove('hidden');
         document.getElementById('furious-name').innerText = failFast.candidate;
         document.getElementById('furious-desc').innerText = `R·ªõt (${failFast.score}ƒë) nh∆∞ng nhanh nh·∫•t (${failFast.timeSaving}p)`;
      } else document.getElementById('badge-furious').classList.add('hidden');
      
      const hintMaster = [...results].sort((a,b) => b.hintsUsed - a.hintsUsed)[0];
      if (hintMaster && hintMaster.hintsUsed > 0) {
        document.getElementById('badge-hint').classList.remove('hidden');
        document.getElementById('hint-name').innerText = hintMaster.candidate;
        document.getElementById('hint-desc').innerText = `S·ªë l·∫ßn d√πng G·ª£i √Ω: ${hintMaster.hintsUsed}/${totalQuestions}`;
      } else document.getElementById('badge-hint').classList.add('hidden');
      
      const zenMaster = [...results].sort((a,b) => a.timeSaving - b.timeSaving)[0];
      if (zenMaster) {
        document.getElementById('badge-zen').classList.remove('hidden');
        document.getElementById('zen-name').innerText = zenMaster.candidate;
        const timeSpent = (testDuration - zenMaster.timeSaving).toFixed(2);
        document.getElementById('zen-desc').innerText = `D√πng nhi·ªÅu th·ªùi gian nh·∫•t (${timeSpent}p)`;
      } else document.getElementById('badge-zen').classList.add('hidden');

      const passList = results.filter(r => r.score >= passScore).sort((a,b) => b.score - a.score); 
      const tbody = document.getElementById('pass-list-body');
      tbody.innerHTML = '';
      if(passList.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400 italic text-xl">Ch∆∞a c√≥ th√≠ sinh n√†o ƒë·∫°t chu·∫©n.</td></tr>';
      else {
        passList.forEach((r, idx) => {
           tbody.innerHTML += `<tr class="hover:bg-green-50"><td class="px-2 py-2 md:px-6 md:py-6 whitespace-nowrap font-extrabold text-highlight text-sm md:text-2xl">#${idx+1}</td><td class="px-2 py-2 md:px-6 md:py-6 whitespace-nowrap font-bold text-highlight text-sm md:text-2xl">${r.candidate}</td><td class="px-2 py-2 md:px-6 md:py-6 whitespace-nowrap text-gray-600 text-sm md:text-xl">${r.position}</td><td class="px-2 py-2 md:px-6 md:py-6 whitespace-nowrap font-extrabold text-deepBlue text-sm md:text-2xl">${r.score}</td><td class="px-2 py-2 md:px-6 md:py-6 whitespace-nowrap text-gray-500 font-bold text-sm md:text-xl">${r.hintsUsed}</td></tr>`;
        });
      }
    }

    function renderChart(inputResults, passScore, totalQuestions) {
       const results = [...inputResults].reverse();
       const ctx = document.getElementById('adminResultsChart').getContext('2d');
       if (resultsChart) { resultsChart.destroy(); resultsChart = null; }
       if(chartBlinkInterval) clearInterval(chartBlinkInterval);
       const container = document.getElementById('chart-container');
       const newHeight = Math.max(400, results.length * 50);
       container.style.height = `${newHeight}px`;
       const scores = results.map(r => r.score);
       const maxScore = Math.max(...scores); 
       const maxIndex = scores.indexOf(maxScore);
       
       const bgColors = scores.map((s, idx) => (idx === maxIndex) ? 'rgba(255, 215, 0, 0.9)' : `rgba(${Math.floor(Math.random()*200)}, ${Math.floor(Math.random()*200)}, ${Math.floor(Math.random()*200)}, 0.5)`);
       const borderColors = scores.map((s, idx) => (idx === maxIndex) ? 'rgba(217, 119, 6, 1)' : bgColors[idx].replace('0.5', '1'));

       resultsChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: results.map(r => r.candidate), datasets: [{ label: 'Score', data: scores, backgroundColor: bgColors, borderColor: borderColors, borderWidth: scores.map((s, idx) => idx === maxIndex ? 3 : 1), barPercentage: 0.6, categoryPercentage: 0.8 }] },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: false, animation: { duration: 1000, easing: 'easeOutQuart' },
          scales: { x: { beginAtZero: true, max: totalQuestions * 1.05, title: { display: true, text: 'Score' }, grid: { display: false }, position: 'top' }, y: { grid: { display: false }, ticks: { autoSkip: false, color: borderColors, font: { weight: 'bold' } } } },
          plugins: { legend: { display: false }, tooltip: { callbacks: { afterLabel: function(c) { return results[c.dataIndex].timestampStr ? 'N·ªôp l√∫c: ' + results[c.dataIndex].timestampStr : ''; } } }, annotation: { annotations: { line1: { type: 'line', xMin: passScore, xMax: passScore, borderColor: 'rgb(220, 38, 38)', borderWidth: 4, borderDash: [6, 4], label: { content: `ƒêi·ªÉm chu·∫©n: ${passScore}`, display: true, position: 'end', backgroundColor: 'rgb(220, 38, 38)', color: 'white', font: { size: 11, weight: 'bold' } } } } } }
        }
      });
      let isBright = true;
      chartBlinkInterval = setInterval(() => { isBright = !isBright; if(resultsChart && maxIndex !== -1) resultsChart.update('none'); }, 5000); 
    }

    // (startQuizFlow, setupQuiz, renderQuestionMap, etc. unchanged)
    function startQuizFlow() {
      const select = document.getElementById('student-test-select');
      const v = select.value;
      if(!v) return;
      
      const selectedOption = select.options[select.selectedIndex];
      const type = selectedOption.getAttribute('data-type');
      
      currentTestDept = selectedOption.getAttribute('data-department') || "";
      currentTestArea = selectedOption.getAttribute('data-area') || "";
      currentTestOccasion = selectedOption.getAttribute('data-occasion') || "";
      currentTestStartTime = selectedOption.getAttribute('data-starttime') || "";

      const context = {
        department: currentTestDept,
        forArea: currentTestArea,
        occasion: currentTestOccasion,
        startTime: currentTestStartTime
      };
      
      currentTestName = v;
      currentTestType = type || "QUIZ";
      toggleLoading(true);
      
      if (currentTestType === 'DISC') runBackend('getDiscTestConfig', v, context); 
      else runBackend('getQuizData', v, context);
    }

    function setupQuiz(data) {
      if(!data) { toggleLoading(false); return alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu ƒë·ªÅ thi'); }
      allQuestions = data.questions;
      totalDuration = data.config.duration;
      currentPassScore = data.config.passScore; 
      currentTestDept = data.config.department || currentTestDept;
      currentTestArea = data.config.forArea || currentTestArea;
      currentTestOccasion = data.config.occasion || currentTestOccasion;
      currentTestStartTime = data.config.startTime || currentTestStartTime;

      currentHintsUsed = 0; 
      document.getElementById('quiz-title-display').innerText = data.config.name;
      
      let displayTitle = data.config.name;
      if (data.config.forArea) displayTitle = `[${data.config.forArea}] ` + displayTitle;
      if (data.config.department) displayTitle += ` - ${data.config.department}`;
      if (data.config.occasion) displayTitle += ` - ${data.config.occasion}`;
      if (data.config.startTime) displayTitle += ` - [B·∫Øt ƒë·∫ßu: ${data.config.startTime}]`;
      
      displayTitle += ` (${data.config.duration} ph√∫t)`;
      
      document.getElementById('entry-quiz-title').innerText = displayTitle;

      document.getElementById('candidate-name').value = "";
      document.getElementById('candidate-position').value = "";
      document.getElementById('error-name').classList.add('hidden');
      document.getElementById('error-position').classList.add('hidden');
      quizTimeRemaining = totalDuration * 60;
      updateTimerDisplay(); 
      totalBlocks = Math.ceil(allQuestions.length / QUESTIONS_PER_BLOCK);
      currentBlockIndex = 0;
      renderQuestionMap(allQuestions.length);
      updateProgressDisplay();
      const c = document.getElementById('questions-container');
      c.innerHTML = '';
      for(let b = 0; b < totalBlocks; b++) {
         const blockDiv = document.createElement('div');
         blockDiv.id = `block-${b}`;
         blockDiv.className = `quiz-block space-y-6 ${b === 0 ? 'quiz-block-visible' : 'quiz-block-hidden'}`;
         const startIndex = b * QUESTIONS_PER_BLOCK;
         const endIndex = Math.min(startIndex + QUESTIONS_PER_BLOCK, allQuestions.length);
         for(let i = startIndex; i < endIndex; i++) {
             const q = allQuestions[i];
             let inputType = q.type === 'Multiple Choice' ? 'checkbox' : 'radio';
             let choicesHtml = '';
             const isTrueFalse = q.type && q.type.toLowerCase().includes('true false');
             if (isTrueFalse) {
               choicesHtml = '<div class="grid grid-cols-2 gap-4">'; 
               q.choices.forEach((choice) => {
                  choicesHtml += `<label class="cursor-pointer relative group select-none"><input type="radio" name="q_${i}" value="${choice}" onchange="updateQuestionStatus(${i})" class="peer sr-only"><div class="p-3 py-4 rounded-xl border-2 border-gray-200 border-b-[6px] bg-white text-center text-gray-500 transition-all duration-100 ease-out active:border-b-2 active:translate-y-[4px] active:bg-blue-50 peer-checked:border-deepBlue peer-checked:bg-blue-100 peer-checked:text-deepBlue peer-checked:border-b-[6px] hover:bg-gray-50 flex flex-col items-center justify-center h-auto"><span class="text-lg font-bold">${choice}</span></div><div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 text-deepBlue transition-opacity"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div></label>`;
               });
               choicesHtml += '</div>';
             } else {
               const labels = ['A','B','C','D'];
               q.choices.forEach((choice, choiceIdx) => {
                 choicesHtml += `<label class="flex items-start p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition"><input type="${inputType}" name="q_${i}" value="${choice}" onchange="updateQuestionStatus(${i})" class="mt-1 mr-3 text-deepBlue focus:ring-deepBlue"><span class="text-gray-700"><b>${labels[choiceIdx] || ''}.</b> ${choice}</span></label>`;
               });
             }
             let hintHtml = q.hint ? `<div class="mb-4"><button id="btn-hint-${i}" type="button" onclick="revealHint(${i})" class="flex items-center gap-1 text-xs font-bold text-orange-600 bg-orange-100 hover:bg-orange-200 px-3 py-1.5 rounded transition"><span>üí° Xem g·ª£i √Ω</span><span class="bg-white px-1 rounded text-[10px] text-orange-400 border border-orange-100">-10s</span></button><div id="hint-content-${i}" class="hidden mt-2 text-sm text-gray-600 bg-yellow-50 p-3 rounded border border-yellow-200 italic"><span class="font-bold text-yellow-600 not-italic">G·ª£i √Ω:</span> ${q.hint}</div></div>` : '';
             blockDiv.insertAdjacentHTML('beforeend', `<div class="bg-white p-6 rounded-xl shadow border-l-4 border-deepBlue relative" id="q-card-${i}"><div class="flex justify-between mb-4"><span class="bg-blue-100 text-deepBlue text-xs font-bold px-2 py-1 rounded uppercase">${q.type}</span><span class="text-gray-400 text-sm font-bold">C√¢u ${i+1}</span></div><p class="text-lg font-semibold text-gray-800 mb-4">${q.question}</p>${hintHtml}<div class="${isTrueFalse ? '' : 'space-y-2'}">${choicesHtml}</div></div>`);
         }
         c.appendChild(blockDiv);
      }
      updateBlockButtons();
      toggleLoading(false);
      showView('view-quiz');
      document.getElementById('quiz-entry-form').classList.remove('hidden');
      document.getElementById('quiz-interface').classList.add('hidden');
      document.getElementById('disc-interface').classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    
    function renderQuestionMap(total) {
      const grid = document.getElementById('question-nav-grid');
      grid.innerHTML = '';
      for(let i=0; i<total; i++) {
        const btn = document.createElement('button');
        btn.id = `nav-btn-${i}`;
        btn.className = 'w-full aspect-square rounded-full font-bold text-xs text-white bg-orange-400 hover:bg-orange-500 transition shadow-sm';
        btn.innerText = i + 1;
        btn.onclick = () => jumpToQuestion(i);
        grid.appendChild(btn);
      }
    }
    function updateQuestionStatus(qIndex) {
      const checked = document.querySelectorAll(`input[name="q_${qIndex}"]:checked`);
      const btn = document.getElementById(`nav-btn-${qIndex}`);
      if(checked.length > 0) { btn.classList.remove('bg-orange-400', 'hover:bg-orange-500'); btn.classList.add('bg-green-500', 'hover:bg-green-600'); } 
      else { btn.classList.remove('bg-green-500', 'hover:bg-green-600'); btn.classList.add('bg-orange-400', 'hover:bg-orange-500'); }
      updateProgressDisplay();
    }
    function updateProgressDisplay() {
      let count = 0;
      for(let i=0; i<allQuestions.length; i++) if(document.querySelectorAll(`input[name="q_${i}"]:checked`).length > 0) count++;
      const el = document.getElementById('progress-display');
      if(el) el.innerText = `(${count}/${allQuestions.length})`;
    }
    function jumpToQuestion(qIndex) {
       const targetBlock = Math.floor(qIndex / QUESTIONS_PER_BLOCK);
       if(targetBlock !== currentBlockIndex) switchBlock(targetBlock);
       setTimeout(() => { const el = document.getElementById(`q-card-${qIndex}`); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300);
    }
    function changeBlock(direction) {
      const newBlock = currentBlockIndex + direction;
      if(newBlock >= 0 && newBlock < totalBlocks) switchBlock(newBlock);
    }
    function switchBlock(index) {
      const currentEl = document.getElementById(`block-${currentBlockIndex}`);
      if(currentEl) { currentEl.classList.remove('quiz-block-visible'); currentEl.classList.add('quiz-block-hidden'); }
      currentBlockIndex = index;
      setTimeout(() => { const newEl = document.getElementById(`block-${currentBlockIndex}`); if(newEl) { newEl.classList.remove('quiz-block-hidden'); newEl.classList.add('quiz-block-visible'); window.scrollTo({ top: 0, behavior: 'smooth' }); } }, 50);
      updateBlockButtons();
    }
    function updateBlockButtons() {
      const prevBtn = document.getElementById('btn-prev-block');
      const nextBtn = document.getElementById('btn-next-block');
      if(prevBtn) { prevBtn.disabled = currentBlockIndex === 0; prevBtn.classList.toggle('opacity-50', currentBlockIndex === 0); }
      if(nextBtn) { nextBtn.disabled = currentBlockIndex === totalBlocks - 1; nextBtn.classList.toggle('opacity-50', currentBlockIndex === totalBlocks - 1); }
    }
    
    function handleStartActualQuiz() {
      const name = document.getElementById('candidate-name').value.trim();
      const pos = document.getElementById('candidate-position').value.trim();
      let isValid = true;
      if(!name) { document.getElementById('error-name').classList.remove('hidden'); isValid = false; } else document.getElementById('error-name').classList.add('hidden');
      if(!pos) { document.getElementById('error-position').classList.remove('hidden'); isValid = false; } else document.getElementById('error-position').classList.add('hidden');
      if(!isValid) return;
      if (currentTestType === 'DISC') { 
         toggleLoading(true, "ƒêang kh·ªüi t·∫°o b√†i thi DISC..."); 
         const context = {
            department: currentTestDept,
            forArea: currentTestArea,
            occasion: currentDiscConfig.occasion,
            startTime: currentTestStartTime
         };
         runBackend('getDiscQuestions', currentTestName, context); 
         return; 
      }
      
      document.getElementById('display-candidate-name').innerText = name;
      document.getElementById('quiz-entry-form').classList.add('hidden');
      document.getElementById('quiz-interface').classList.remove('hidden');
      startTimer(totalDuration);
      window.scrollTo(0,0);
    }

    function revealHint(idx) {
      const btn = document.getElementById(`btn-hint-${idx}`);
      const content = document.getElementById(`hint-content-${idx}`);
      if(btn && content) {
        btn.classList.add('hidden'); content.classList.remove('hidden'); currentHintsUsed++; quizTimeRemaining -= 10;
        if(quizTimeRemaining < 0) quizTimeRemaining = 0;
        updateTimerDisplay();
      }
    }
    function startTimer(min) {
      if(timerInterval) clearInterval(timerInterval);
      quizTimeRemaining = min * 60;
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        quizTimeRemaining--;
        updateTimerDisplay();
        if(quizTimeRemaining <= 0) { clearInterval(timerInterval); submitQuiz(true); }
      }, 1000);
    }
    function updateTimerDisplay() {
      const m = Math.floor(quizTimeRemaining / 60);
      const s = Math.floor(quizTimeRemaining % 60);
      const el = document.getElementById('timer-display');
      el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      el.classList.toggle('text-red-600', quizTimeRemaining < 60);
      if(quizTimeRemaining <= 30 && quizTimeRemaining > 0) el.classList.add('animate-pulse', 'scale-125', 'origin-center');
      else el.classList.remove('animate-pulse', 'scale-125', 'origin-center');
    }
    function showConfirmModal(count, callback) {
      document.getElementById('confirm-modal-text').innerHTML = `B·∫°n c√≤n <strong class="text-red-600 text-lg">${count}</strong> c√¢u h·ªèi ch∆∞a tr·∫£ l·ªùi.<br>N·∫øu n·ªôp ngay, c√°c c√¢u n√†y s·∫Ω kh√¥ng c√≥ ƒëi·ªÉm.<br>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?`;
      const btn = document.getElementById('confirm-modal-btn');
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      newBtn.onclick = () => { closeConfirmModal(); callback(); };
      document.getElementById('confirm-modal').classList.remove('hidden');
    }
    function closeConfirmModal() { document.getElementById('confirm-modal').classList.add('hidden'); }

    function submitQuiz(force=false) {
      try {
        const name = document.getElementById('candidate-name').value.trim();
        const pos = document.getElementById('candidate-position').value.trim();
        if(!force && (!name || !pos)) { alert("L·ªói: Th√¥ng tin th√≠ sinh b·ªã thi·∫øu."); return; }
        if (!force) {
          let answeredCount = 0;
          allQuestions.forEach((q, idx) => { if(document.querySelectorAll(`input[name="q_${idx}"]:checked`).length > 0) answeredCount++; });
          const unanswered = allQuestions.length - answeredCount;
          if (unanswered > 0) { showConfirmModal(unanswered, () => { submitQuiz(true); }); return; }
        }
        clearInterval(timerInterval);
        const answers = allQuestions.map((q, idx) => ({ question: q.question, selected: Array.from(document.querySelectorAll(`input[name="q_${idx}"]:checked`)).map(e => e.value) }));
        const timeSavingMin = (quizTimeRemaining / 60).toFixed(2);
        
        const payload = { 
            testName: currentTestName, 
            candidate: name || "Unknown", 
            position: pos || "Unknown", 
            timeSaving: timeSavingMin, 
            answers: answers, 
            hintsUsed: currentHintsUsed,
            department: currentTestDept,
            forArea: currentTestArea,
            occasion: currentTestOccasion,
            startTime: currentTestStartTime
        };
        toggleLoading(true, "ƒêang ch·∫•m ƒëi·ªÉm...");
        runBackend('submitQuiz', payload);
      } catch (e) { console.error(e); alert("C√≥ l·ªói x·∫£y ra: " + e.message); }
    }

    function showResult(data) {
      toggleLoading(false);
      showView('view-result');
      const name = document.getElementById('candidate-name').value;
      const pos = document.getElementById('candidate-position').value;
      document.getElementById('result-candidate-name').innerText = name || "Th√≠ sinh";
      document.getElementById('result-candidate-position').innerText = pos || "Ch∆∞a c·∫≠p nh·∫≠t";
      document.getElementById('final-score-display').innerText = data && data.score ? data.score : "0.00";
      document.getElementById('final-hints-display').innerText = `${(data && data.hintsUsed !== undefined) ? data.hintsUsed : 0}/${allQuestions.length}`;
      startPollingLiveFeed();
      if (!data || !data.details) {
         document.getElementById('result-detail-viewer').innerHTML = `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4"><p class="text-sm text-yellow-700 font-bold">L∆∞u √Ω: Kh√¥ng th·ªÉ hi·ªÉn th·ªã chi ti·∫øt.</p></div>`;
         return;
      }
      currentResultDetails = data.details;
      renderResultMap();
      if(currentResultDetails.length > 0) showResultDetail(0);
    }

    function renderResultMap() {
        const grid = document.getElementById('result-map-grid');
        grid.innerHTML = '';
        currentResultDetails.forEach((item, index) => {
            const btn = document.createElement('button');
            const isCorrect = item.isCorrect;
            let classes = 'w-full aspect-square rounded-full font-bold text-sm md:text-base text-white shadow-md transition-all duration-200 transform hover:scale-110 focus:ring-4 focus:ring-offset-2 focus:ring-blue-300 ';
            classes += isCorrect ? 'bg-gradient-to-br from-green-400 to-green-600 hover:from-green-500 hover:to-green-700' : 'bg-gradient-to-br from-red-400 to-red-600 hover:from-red-500 hover:to-red-700';
            btn.className = classes; btn.innerText = index + 1; btn.onclick = () => showResultDetail(index);
            grid.appendChild(btn);
        });
    }
    function showResultDetail(index) {
        const container = document.getElementById('result-detail-viewer');
        const item = currentResultDetails[index];
        const originalQ = allQuestions[index];
        const getLabel = (txt) => { if (!originalQ || !originalQ.choices) return ""; const i = originalQ.choices.indexOf(txt); return i > -1 ? String.fromCharCode(65 + i) + ". " : ""; };
        const isCorrect = item.isCorrect;
        let userAnsHtml = item.userSelected.length > 0 ? item.userSelected.map(t => `<span class="="${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-2 py-1 rounded text-sm font-medium border border-opacity-20"><b>${getLabel(t)}</b>${t}</span>`).join(' ') : '<span class="text-gray-400 italic">Kh√¥ng ch·ªçn ƒë√°p √°n</span>';
        let correctAnsHtml = item.correctTexts && item.correctTexts.length > 0 ? item.correctTexts.map(t => `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium border border-blue-200"><b>${getLabel(t)}</b>${t}</span>`).join(' ') : '<span class="text-gray-400 italic">Kh√¥ng t√¨m th·∫•y ƒë√°p √°n</span>';
        container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-lg border-l-8 ${isCorrect ? 'border-green-500' : 'border-red-500'} animate-fade-in relative"><span class="absolute top-4 right-4 text-xs font-bold text-gray-400">C√¢u ${index + 1}</span><div class="flex gap-4 mb-4"><div class="flex-shrink-0"><div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl ${isCorrect ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${isCorrect ? '‚úì' : '‚úï'}</div></div><h4 class="font-bold text-gray-800 text-lg pt-1">${item.question}</h4></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg"><div><span class="text-xs font-bold text-gray-500 uppercase block mb-1">B·∫°n ch·ªçn:</span><div class="flex flex-wrap gap-2">${userAnsHtml}</div></div>${!isCorrect ? `<div><span class="text-xs font-bold text-gray-500 uppercase block mb-1">ƒê√°p √°n ƒë√∫ng:</span><div class="flex flex-wrap gap-2">${correctAnsHtml}</div></div>` : `<div class="flex items-center text-green-600 font-bold"><span>Ch√≠nh x√°c! Tuy·ªát v·ªùi.</span></div>`}</div>${item.hint ? `<div class="mt-3 text-sm text-gray-500 italic border-t pt-2">G·ª£i √Ω ƒë√£ d√πng: ${item.hint}</div>` : ''}</div>`;
        const grid = document.getElementById('result-map-grid');
        Array.from(grid.children).forEach((btn, idx) => { if(idx === index) { btn.classList.add('ring-4', 'ring-blue-300', 'scale-110'); } else { btn.classList.remove('ring-4', 'ring-blue-300', 'scale-110'); } });
    }

    function startPollingLiveFeed() {
      if (pollingInterval) clearInterval(pollingInterval);
      displayedFeedJSON = ""; 
      document.getElementById('live-feed-score-pass').innerText = `ƒêi·ªÉm chu·∫©n: ${currentPassScore}`;
      document.getElementById('live-feed-list').innerHTML = '<div class="text-center text-gray-400 py-4 text-sm italic">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
      runBackend('getRecentResults', currentTestName, currentTestDept, currentTestArea);
      pollingInterval = setInterval(() => { runBackend('getRecentResults', currentTestName, currentTestDept, currentTestArea); }, 5000);
    }
    function stopPollingLiveFeed() { if (pollingInterval) clearInterval(pollingInterval); pollingInterval = null; }
    function updateLiveFeed(data) {
      if (!data) return;
      const currentJSON = JSON.stringify(data);
      if (currentJSON === displayedFeedJSON) return;
      displayedFeedJSON = currentJSON;
      const container = document.getElementById('live-feed-list');
      if (data.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm italic">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o kh√°c.</div>'; return; }
      container.innerHTML = '';
      data.forEach((item, index) => {
        const isFail = parseFloat(item.score) < parseFloat(currentPassScore);
        const html = `<div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-100 shadow-sm animate-slide-in-right" style="animation-delay: ${index*0.1}s;"><div class="flex items-center gap-3 overflow-hidden"><div class="w-8 h-8 rounded-full bg-blue-100 text-deepBlue flex items-center justify-center font-bold text-xs flex-shrink-0">${item.candidate.charAt(0).toUpperCase()}</div><div class="flex flex-col min-w-0"><span class="font-semibold text-gray-800 text-sm truncate flex items-center">${item.candidate} ${isFail ? '<span class="bg-red-500 text-white text-[9px] font-bold px-1 py-0.5 rounded ml-1">FAIL</span>' : ''}</span><span class="text-[10px] text-gray-400">${item.timestamp.split(' ')[1] || ''}</span></div></div><div class="flex-shrink-0"><span class="font-bold text-highlight text-lg">${item.score}</span><span class="text-[10px] text-gray-500 block text-right">ƒëi·ªÉm</span></div></div>`;
        container.insertAdjacentHTML('beforeend', html);
      });
    }
    function returnToHome() {
      stopPollingLiveFeed();
      document.getElementById('candidate-name').value = ""; document.getElementById('candidate-position').value = ""; document.getElementById('student-test-select').value = ""; document.getElementById('admin-user').value = ""; document.getElementById('admin-pass').value = "";
      currentTestName = ""; allQuestions = []; currentHintsUsed = 0; currentResultDetails = [];
      if(timerInterval) clearInterval(timerInterval);
      showView('view-home');
    }
    function scrollToLiveFeed() { document.getElementById('live-feed-container').scrollIntoView({ behavior: 'smooth' }); }
    function scrollToPassList() { document.getElementById('pass-list-section').scrollIntoView({ behavior: 'smooth' }); }

    // --- DISC JS LOGIC ---
    // (Existing DISC logic functions unchanged)
    function setupDiscEntry(data) {
        if(!data) { toggleLoading(false); return alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c c·∫•u h√¨nh DISC'); }
        toggleLoading(false); currentDiscConfig = data;
        currentTestDept = data.department || "";
        currentTestArea = data.forArea || "";
        currentTestOccasion = data.occasion || "";
        currentTestStartTime = data.startTime || "";

        let displayTitle = data.name;
        if (data.forArea) displayTitle = `[${data.forArea}] ` + displayTitle;
        if (data.department) displayTitle += ` - ${data.department}`;
        if (data.occasion) displayTitle += ` - ${data.occasion}`;
        if (data.startTime) displayTitle += ` - [B·∫Øt ƒë·∫ßu: ${data.startTime}]`;

        displayTitle += ` (${data.duration} ph√∫t)`;

        document.getElementById('entry-quiz-title').innerText = displayTitle;

        document.getElementById('candidate-name').value = ""; document.getElementById('candidate-position').value = "";
        document.getElementById('error-name').classList.add('hidden'); document.getElementById('error-position').classList.add('hidden');
        showView('view-quiz');
        document.getElementById('quiz-entry-form').classList.remove('hidden');
        document.getElementById('quiz-interface').classList.add('hidden');
        document.getElementById('disc-interface').classList.add('hidden');
    }
    function setupDiscInterface(data) {
        toggleLoading(false);
        if(!data || !data.questions || data.questions.length === 0) { alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu c√¢u h·ªèi DISC."); return; }
        discQuestions = data.questions; discSelections = {}; currentDiscBlockIndex = 0;
        
        strMostFit = "";
        strLeastFit = "";
        strMostNonFit = "";

        totalDiscBlocks = Math.ceil(discQuestions.length / DISC_QUESTIONS_PER_BLOCK);
        document.getElementById('disc-name-display').innerText = document.getElementById('candidate-name').value || "Th√≠ sinh";
        discMainTimeRemaining = (Number(data.config.duration) || 30) * 60;
        discBlockDurationConfig = (Number(data.config.blockDuration) || 2) * 60;
        discBlockTimeRemaining = discBlockDurationConfig;
        updateDiscTimersDisplay(); renderDiscBlock(0);
        document.getElementById('quiz-entry-form').classList.add('hidden');
        document.getElementById('disc-interface').classList.remove('hidden');
        document.getElementById('disc-instruction-modal').classList.remove('hidden');
        window.scrollTo(0,0);
    }
    function startDiscTestNow() { document.getElementById('disc-instruction-modal').classList.add('hidden'); startDiscTimers(); }
    function startDiscTimers() {
        if(discMainInterval) clearInterval(discMainInterval); if(discBlockInterval) clearInterval(discBlockInterval);
        discMainInterval = setInterval(() => { if(discMainTimeRemaining > 0) { discMainTimeRemaining--; updateDiscTimersDisplay(); } else { clearInterval(discMainInterval); if(discBlockInterval) clearInterval(discBlockInterval); handleDiscTimeout(); } }, 1000);
        discBlockInterval = setInterval(() => { if(discBlockTimeRemaining > 0) { discBlockTimeRemaining--; updateDiscTimersDisplay(); } }, 1000);
    }
    function updateDiscTimersDisplay() {
        const m = Math.floor(discMainTimeRemaining / 60); const s = Math.floor(discMainTimeRemaining % 60);
        const el = document.getElementById('disc-main-timer');
        el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        
        if (discMainTimeRemaining <= 60) {
            el.classList.add('text-red-600', 'animate-pulse', 'scale-110');
        } else {
            el.classList.remove('text-red-600', 'animate-pulse', 'scale-110');
        }

        const bm = Math.floor(discBlockTimeRemaining / 60); const bs = Math.floor(discBlockTimeRemaining % 60);
        const elBlock = document.getElementById('disc-block-timer');
        elBlock.innerText = `${bm.toString().padStart(2,'0')}:${bs.toString().padStart(2,'0')}`;
        
        if (discBlockTimeRemaining <= 5) {
            elBlock.classList.add('text-red-600', 'animate-pulse-fast', 'scale-125');
        } else {
            elBlock.classList.remove('text-red-600', 'animate-pulse-fast', 'scale-125');
        }
    }
    function handleDiscTimeout() {
        let mostCount = 0, leastCount = 0;
        for (const k in discSelections) { if (discSelections[k] === 'MOST') mostCount++; if (discSelections[k] === 'LEAST') leastCount++; }
        if (mostCount === totalDiscBlocks && leastCount === totalDiscBlocks) submitDiscTest();
        else document.getElementById('disc-timeout-modal').classList.remove('hidden');
    }
    function resetDiscTest() {
        document.getElementById('disc-timeout-modal').classList.add('hidden');
        discSelections = {}; currentDiscBlockIndex = 0;
        strMostFit = ""; strLeastFit = ""; strMostNonFit = "";
        discMainTimeRemaining = (Number(currentDiscConfig.duration) || 7) * 60;
        discBlockTimeRemaining = discBlockDurationConfig;
        updateDiscTimersDisplay(); renderDiscBlock(0); startDiscTimers();
    }
    function renderDiscBlock(blockIndex) {
        const container = document.getElementById('disc-questions-container');
        const start = blockIndex * DISC_QUESTIONS_PER_BLOCK;
        const end = Math.min(start + DISC_QUESTIONS_PER_BLOCK, discQuestions.length);
        let html = `<div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-highlight animate-slide-up-fade overflow-hidden"><table class="w-full border-collapse"><thead><tr class="bg-gray-100 text-deepBlue text-lg md:text-xl"><th class="p-3 text-left w-1/2 font-bold">C·ª•m t·ª´ m√¥ t·∫£ t√≠nh c√°ch</th><th class="p-3 text-center w-1/4 font-bold text-green-700">Gi·ªëng t√¥i nh·∫•t</th><th class="p-3 text-center w-1/4 font-bold text-red-600">√çt gi·ªëng t√¥i nh·∫•t</th></tr></thead><tbody>`;
        for(let i=start; i<end; i++) {
            const q = discQuestions[i];
            const isMost = discSelections[String(q.id)] === 'MOST';
            const isLeast = discSelections[String(q.id)] === 'LEAST';
            html += `<tr class="border-b hover:bg-gray-50 transition-colors"><td class="p-3 text-gray-800 font-medium text-lg md:text-2xl">${q.content}</td><td class="p-3 text-center"><label class="cursor-pointer inline-flex items-center justify-center p-2 rounded-full hover:bg-green-100 transition-colors"><input type="radio" id="radio-most-${q.id}" name="disc_block_most" value="${q.id}" class="h-6 w-6 text-green-600 focus:ring-green-500 cursor-pointer" onchange="handleDiscRadio('MOST', '${q.id}')" ${isMost ? 'checked' : ''}></label></td><td class="p-3 text-center"><label class="cursor-pointer inline-flex items-center justify-center p-2 rounded-full hover:bg-red-100 transition-colors"><input type="radio" id="radio-least-${q.id}" name="disc_block_least" value="${q.id}" class="h-6 w-6 text-red-600 focus:ring-red-500 cursor-pointer" onchange="handleDiscRadio('LEAST', '${q.id}')" ${isLeast ? 'checked' : ''}></label></td></tr>`;
        }
        html += `</tbody></table></div>`;
        container.innerHTML = html;
        document.getElementById('disc-progress-bar').style.width = `${((blockIndex + 1) / totalDiscBlocks) * 100}%`;
        document.getElementById('disc-progress-text').innerText = `${blockIndex + 1}/${totalDiscBlocks}`;
        document.getElementById('btn-disc-prev').classList.add('hidden');
        const nextBtn = document.getElementById('btn-disc-next');
        if(blockIndex === totalDiscBlocks - 1) {
            nextBtn.innerHTML = `<span class="mr-2">Click ƒë·ªÉ Submit B√†i test</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
            nextBtn.onclick = checkAndSubmitDisc;
            nextBtn.classList.remove('bg-highlight', 'hover:bg-orange-600'); nextBtn.classList.add('bg-green-600', 'hover:bg-green-700', 'animate-pulse');
        } else {
            nextBtn.innerText = "Ti·∫øp t·ª•c"; nextBtn.onclick = () => changeDiscBlock(1);
            nextBtn.classList.add('bg-highlight', 'hover:bg-orange-600'); nextBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'animate-pulse');
        }
    }
    function handleDiscRadio(type, qId) {
        qId = String(qId);
        const start = currentDiscBlockIndex * DISC_QUESTIONS_PER_BLOCK;
        const end = Math.min(start + DISC_QUESTIONS_PER_BLOCK, discQuestions.length);
        for(let i=start; i<end; i++) {
            const tempId = String(discQuestions[i].id);
            if (type === 'MOST' && discSelections[tempId] === 'MOST' && tempId !== qId) delete discSelections[tempId];
            if (type === 'LEAST' && discSelections[tempId] === 'LEAST' && tempId !== qId) delete discSelections[tempId];
        }
        const otherType = type === 'MOST' ? 'least' : 'most';
        const sibling = document.getElementById(`radio-${otherType}-${qId}`);
        if(sibling && sibling.checked) sibling.checked = false;
        discSelections[qId] = type;
    }
    
    function updateCultureVars() {
        let mfArr = [];
        let lfArr = [];
        let mnfArr = [];
        
        discQuestions.forEach(q => {
            const qId = String(q.id);
            const selection = discSelections[qId];
            
            if (selection) {
                if (q.isFit && selection === 'MOST') mfArr.push(q.content);
                if (q.isFit && selection === 'LEAST') lfArr.push(q.content);
                if (q.isNonFit && selection === 'MOST') mnfArr.push(q.content);
            }
        });
        
        strMostFit = mfArr.join('\n');
        strLeastFit = lfArr.join('\n');
        strMostNonFit = mnfArr.join('\n');
    }

    function changeDiscBlock(dir) {
        const start = currentDiscBlockIndex * DISC_QUESTIONS_PER_BLOCK;
        const end = Math.min(start + DISC_QUESTIONS_PER_BLOCK, discQuestions.length);
        let m=0, l=0;
        for(let i=start; i<end; i++) { if(discSelections[String(discQuestions[i].id)] === 'MOST') m++; if(discSelections[String(discQuestions[i].id)] === 'LEAST') l++; }
        if(m!==1 || l!==1) { document.getElementById('disc-error-msg').classList.remove('hidden'); return; }
        document.getElementById('disc-error-msg').classList.add('hidden');
        updateCultureVars();
        
        if(currentDiscBlockIndex + dir < totalDiscBlocks) { currentDiscBlockIndex += dir; discBlockTimeRemaining = discBlockDurationConfig; updateDiscTimersDisplay(); renderDiscBlock(currentDiscBlockIndex); }
    }
    function checkAndSubmitDisc() { changeDiscBlock(0); submitDiscTest(); }
    function submitDiscTest() {
        if(discMainInterval) clearInterval(discMainInterval); if(discBlockInterval) clearInterval(discBlockInterval);
        updateCultureVars();
        
        const name = document.getElementById('candidate-name').value; const pos = document.getElementById('candidate-position').value;
        const counts = { MOST: { D: 0, I: 0, S: 0, C: 0 }, LEAST: { D: 0, I: 0, S: 0, C: 0 } };
        const mapValToKey = { 1: 'D', 2: 'I', 3: 'S', 4: 'C' };
        for (const [qId, type] of Object.entries(discSelections)) {
            const q = discQuestions.find(item => String(item.id) === String(qId));
            if (q) { const val = type === 'MOST' ? q.mostValue : q.leastValue; const key = mapValToKey[val]; if (key) counts[type][key]++; }
        }
        const strLeast = calculateDiscString(counts.LEAST, GRAPH_II_MAPPING, 7);
        const strMost = calculateDiscString(counts.MOST, GRAPH_III_MAPPING, 12);
        
        toggleLoading(true, "ƒêang n·ªôp b√†i DISC...");
        runBackend('submitDiscTest', { 
          testName: currentTestName, 
          department: currentTestDept,
          forArea: currentTestArea,
          occasion: currentTestOccasion, 
          startTime: currentTestStartTime,

          candidate: name || "Unknown", 
          position: pos || "Unknown", 
          selections: discSelections, 
          currentDisc: strLeast, 
          trendDisc: strMost,
          cultureAnalysis: {
             mostFit: strMostFit,
             leastFit: strLeastFit,
             mostNonFit: strMostNonFit
          }
        });
    }
    function showDiscResult(data) {
        toggleLoading(false);
        showView('view-disc-result');
        const counts = { MOST: { D: 0, I: 0, S: 0, C: 0 }, LEAST: { D: 0, I: 0, S: 0, C: 0 } };
        const mapValToKey = { 1: 'D', 2: 'I', 3: 'S', 4: 'C' };
        for (const [qId, type] of Object.entries(discSelections)) {
            const q = discQuestions.find(item => String(item.id) === String(qId));
            if (q) { const val = type === 'MOST' ? q.mostValue : q.leastValue; const key = mapValToKey[val]; if (key) counts[type][key]++; }
        }
        document.getElementById('disc-result-subtitle').innerText = `${document.getElementById('candidate-name').value} - ${document.getElementById('candidate-position').value}`;
        const strLeast = calculateDiscString(counts.LEAST, GRAPH_II_MAPPING, 7);
        document.getElementById('subtitle-graph-least').innerText = strLeast || "(Kh√¥ng x√°c ƒë·ªãnh)";
        drawDiscChart('disc-chart-least', counts.LEAST, GRAPH_II_MAPPING, { midlineIndex: 7, numRows: 20 });
        const strMost = calculateDiscString(counts.MOST, GRAPH_III_MAPPING, 12);
        document.getElementById('subtitle-graph-most').innerText = strMost || "(Kh√¥ng x√°c ƒë·ªãnh)";
        drawDiscChart('disc-chart-most', counts.MOST, GRAPH_III_MAPPING, { midlineIndex: 12, numRows: 22 });
    }

    // --- DISC GRAPH LOGIC ---
    function getRowIndex(val, col, mapping) {
        const exact = mapping.find(r => r[col] === val); if (exact) return exact.id;
        let minDiff = Infinity, index = -1;
        mapping.forEach(row => { if (row[col] !== null && row[col] !== undefined) { const diff = Math.abs(row[col] - val); if (diff < minDiff) { minDiff = diff; index = row.id; } } });
        return index;
    }
    function calculateDiscString(scores, mapping, midlineLimit) {
        const factors = ['D', 'I', 'S', 'C']; const active = [];
        factors.forEach(f => { const idx = getRowIndex(scores[f], f, mapping); if(idx !== -1 && idx <= midlineLimit) active.push({f, idx}); });
        active.sort((a,b) => a.idx - b.idx); return active.map(x=>x.f).join(" ");
    }
    function drawDiscChart(canvasId, scores, mapping, config) {
        const canvas = document.getElementById(canvasId); if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr; ctx.scale(dpr, dpr);
        const w = rect.width, h = rect.height;
        const cols = ['D', 'I', 'S', 'C']; const numRows = config.numRows; const headerH = 40, margin = 20, gridH = h - headerH - margin, rowH = gridH / numRows, colW = (w - margin * 2) / 4;
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, w, h);
        
        ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        cols.forEach((col, i) => { const x = margin + colW * i + colW / 2; ctx.fillStyle = '#000'; ctx.fillText(col, x, headerH / 2); ctx.strokeRect(margin + colW * i, 0, colW, headerH); });
        
        ctx.font = '12px sans-serif'; ctx.lineWidth = 1;
        for (let r = 0; r < numRows; r++) {
            const y = headerH + r * rowH;
            const rowData = mapping.find(item => item.id === r);
            if (r === config.midlineIndex) { ctx.beginPath(); ctx.moveTo(margin, y + rowH); ctx.lineTo(w - margin, y + rowH); ctx.strokeStyle = '#6b7280'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]); ctx.lineWidth = 1; }
            cols.forEach((col, c) => {
                const x = margin + colW * c; const cx = x + colW / 2; const cy = y + rowH / 2;
                ctx.beginPath(); ctx.moveTo(x, headerH); ctx.lineTo(x, h - margin); ctx.strokeStyle = '#e5e7eb'; ctx.stroke();
                if (rowData && rowData[col] !== null && rowData[col] !== undefined) { ctx.fillStyle = '#374151'; ctx.fillText(rowData[col], cx, cy); }
            });
        }
        ctx.strokeRect(margin, headerH, w - margin * 2, gridH);
        
        const points = [];
        cols.forEach((col, c) => {
            const score = scores[col]; const x = margin + colW * c + colW / 2;
            const rowIndex = getRowIndex(score, col, mapping);
            if (rowIndex !== -1) { const y = headerH + rowIndex * rowH + rowH / 2; points.push({ x, y }); }
        });
        if (points.length > 0) {
            ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y);
            for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);
            ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 3; ctx.stroke();
            points.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI * 2); ctx.fillStyle = '#ffffff'; ctx.fill(); ctx.lineWidth = 3; ctx.strokeStyle = '#dc2626'; ctx.stroke(); });
        }
    }

    // --- DISC ADMIN LOGIC ---
    function loadDiscAdminData() { toggleLoading(true, "ƒêang t·∫£i d·ªØ li·ªáu DISC..."); runBackend('getDiscResultsForAdmin'); }
    function initDiscAdmin(dataWrapper) {
        toggleLoading(false); 
        const allResults = dataWrapper.results || [];
        discAllResultsGlobal = allResults; // STORE GLOBAL
        
        const role = (currentUserRole || "").trim().toLowerCase();
        // Normalize department for checking
        const userDept = (currentUserDept || "").trim().toUpperCase();

        const isSuperAdmin = role.includes('super admin');
        const isQLKV = role.includes('qlkv');
        const isAdmin = role.includes('admin') && !isSuperAdmin;
        
        // HR Admin Exception: If role is Admin and Dept is HR, they see everything
        const isHRAdmin = isAdmin && userDept === 'HR';

        discRawData = allResults.filter(item => {
           if (isSuperAdmin) return true;
           if (isHRAdmin) return true; // HR Admin sees all DISC results
           if (isAdmin) return item.department === currentUserDept;
           if (isQLKV) return item.forArea === currentUserArea;
           return false;
        });

        if (dataWrapper.meta) {
           discTotalFit = dataWrapper.meta.totalFit || 0;
           discTotalNonFit = dataWrapper.meta.totalNonFit || 0;
        }

        const occasions = [...new Set(discRawData.map(item => item.occasion || ""))].filter(x => x);
        const select = document.getElementById('disc-filter-occasion'); select.innerHTML = '<option value="ALL">T·∫•t c·∫£</option>';
        occasions.forEach(occ => { select.innerHTML += `<option value="${occ}">${occ}</option>`; });
        
        const selectTopic = document.getElementById('disc-filter-topic');
        selectTopic.innerHTML = '<option value="" disabled selected>Click ch·ªçn t·ª´ kh√≥a...</option>';
        
        const keywords = new Set();
        occasions.forEach(occ => {
           let text = occ;
           const dateRegex = /\b\d{4}[\/.-]\d{1,2}[\/.-]\d{1,2}\b|\b\d{1,2}[\/.-]\d{1,2}[\/.-]\d{2,4}\b|\b\d{1,2}[\/.-]\d{4}\b/g;
           const dates = text.match(dateRegex);
           if(dates) {
             dates.forEach(d => keywords.add(d));
             text = text.replace(dateRegex, " "); 
           }
           const tokens = text.split(/\s+/);
           tokens.forEach(t => { if(t.trim().length > 1 && isNaN(Number(t.trim()))) keywords.add(t.trim()); });
        });
        
        Array.from(keywords).sort().forEach(k => {
           selectTopic.innerHTML += `<option value="${k}">${k}</option>`;
        });

        updateCandidateDatalist(); 
        updateCultureCandidateDatalist(); 
        populateDiscTimeEmployeeDropdown(); // NEW: Populate time analysis dropdown
        
        toggleDiscFilterMode(); 
        processDiscData();
        
        drawMultiDiscChart('admin-disc-chart-least', [], 'least', GRAPH_II_MAPPING, { midlineIndex: 7, numRows: 20 }, 'legend-current');
        drawMultiDiscChart('admin-disc-chart-most', [], 'most', GRAPH_III_MAPPING, { midlineIndex: 12, numRows: 22 }, 'legend-trend');

        drawMultiDiscChart('disc-time-chart-least', [], 'least', GRAPH_II_MAPPING, { midlineIndex: 7, numRows: 20 }, 'legend-time-current');
        drawMultiDiscChart('disc-time-chart-most', [], 'most', GRAPH_III_MAPPING, { midlineIndex: 12, numRows: 22 }, 'legend-time-trend');
    }
    
    function clearDiscTopicFilter() {
      document.getElementById('disc-filter-topic').value = "";
      processDiscData();
    }
    
    function toggleDiscFilterMode() {
        const radios = document.getElementsByName('discFilterMode'); let mode = 'occasion'; for(const r of radios) if(r.checked) mode = r.value;
        const divOcc = document.getElementById('container-filter-occasion'); const divTopic = document.getElementById('container-filter-topic');
        if (mode === 'occasion') { divOcc.classList.remove('hidden'); divTopic.classList.add('hidden'); document.getElementById('disc-filter-topic').value = ""; } 
        else { divOcc.classList.add('hidden'); divTopic.classList.remove('hidden'); document.getElementById('disc-filter-occasion').value = "ALL"; }
        processDiscData();
    }
    function processDiscData() {
        const radios = document.getElementsByName('discFilterMode'); let mode = 'occasion'; for(const r of radios) if(r.checked) mode = r.value;
        discFilteredData = discRawData.filter(item => {
            if (mode === 'occasion') { const occFilter = document.getElementById('disc-filter-occasion').value; return (occFilter === 'ALL') || (item.occasion === occFilter); } 
            else { const topicFilter = document.getElementById('disc-filter-topic').value.toLowerCase().trim(); if (!topicFilter) return true; return (item.occasion || "").toLowerCase().includes(topicFilter); }
        });
        updateDiscGeneralStats();
    }
    function updateDiscGeneralStats() {
        const countEl = document.getElementById('disc-overview-total-count');
        if(countEl) countEl.innerText = discFilteredData.length;

        const currentCounts = {D:0, I:0, S:0, C:0}; const trendCounts = {D:0, I:0, S:0, C:0};
        
        discFilteredData.forEach(item => {
            if(item.currentDiscStr) {
                const parts = item.currentDiscStr.split(/\s+/);
                parts.forEach(p => { const char = p.trim().toUpperCase(); if(currentCounts[char] !== undefined) currentCounts[char]++; });
            }
            if(item.trendDiscStr) {
                const parts = item.trendDiscStr.split(/\s+/);
                parts.forEach(p => { const char = p.trim().toUpperCase(); if(trendCounts[char] !== undefined) trendCounts[char]++; });
            }
        });

        if (discPieCurrent) discPieCurrent.destroy(); discPieCurrent = drawPieChart('chart-pie-current', currentCounts);
        if (discPieTrend) discPieTrend.destroy(); discPieTrend = drawPieChart('chart-pie-trend', trendCounts);
    }
    function drawPieChart(canvasId, counts) {
        const ctx = document.getElementById(canvasId).getContext('2d'); const total = counts.D + counts.I + counts.S + counts.C;
        const discColors = { 'D': '#ef4444', 'I': '#f59e0b', 'S': '#10b981', 'C': '#3b82f6' };
        return new Chart(ctx, { 
            type: 'pie', 
            data: { 
                labels: ['D', 'I', 'S', 'C'], 
                datasets: [{ 
                    data: [counts.D, counts.I, counts.S, counts.C], 
                    backgroundColor: [discColors.D, discColors.I, discColors.S, discColors.C], 
                    borderWidth: 2, 
                    borderColor: '#ffffff',
                    hoverOffset: 15,
                    hoverBorderColor: '#ffffff'
                }] 
            }, 
            options: { 
                layout: { padding: 20 },
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    tooltip: { enabled: false },
                    legend: { display: false }, 
                    datalabels: { 
                        color: '#ffffff', 
                        font: { weight: 'bold', size: 14 }, 
                        formatter: (value, context) => { 
                            if (value === 0) return ''; 
                            const pct = total > 0 ? Math.round((value/total)*100) : 0; 
                            return context.chart.data.labels[context.dataIndex] + '\n' + pct + '%'; 
                        } 
                    } 
                } 
            }, 
            plugins: [ChartDataLabels] 
        });
    }
    function updateCandidateDatalist() {
        const datalist = document.getElementById('disc-candidates-list'); datalist.innerHTML = '';
        discRawData.forEach(item => { if (!discSelectedCandidates.includes(Number(item.id))) datalist.innerHTML += `<option value="${item.name} | ${item.position}"></option>`; });
    }
    function addPersonToAnalysis() {
        const input = document.getElementById('disc-search-input'); const val = input.value.trim(); if(!val) return;
        const person = discRawData.find(x => `${x.name} | ${x.position}` === val);
        if(person && !discSelectedCandidates.includes(Number(person.id))) { discSelectedCandidates.push(Number(person.id)); renderAnalysisTable(); updateCandidateDatalist(); }
        input.value = "";
    }
    function renderAnalysisTable() {
        const tbody = document.getElementById('disc-analysis-table-body'); tbody.innerHTML = ''; const people = [];
        discSelectedCandidates.forEach(id => {
            const p = discRawData.find(x => Number(x.id) === id);
            if(p) {
                people.push(p);
                tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b"><td class="p-2"><div class="font-bold text-deepBlue">${p.name}</div><div class="text-[10px] text-gray-500">${p.position}</div></td><td class="p-2"><div class="text-[10px]"><span class="text-blue-600 font-bold">C:</span> ${p.currentDiscStr}</div><div class="text-[10px]"><span class="text-orange-600 font-bold">T:</span> ${p.trendDiscStr}</div></td><td class="p-2 text-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-deepBlue" checked onchange="updateComparisonCharts()" data-id="${p.id}"></td></tr>`;
            }
        });
        updateComparisonCharts();
    }
    function updateComparisonCharts() {
        const checkboxes = document.querySelectorAll('#disc-analysis-table-body input[type="checkbox"]:checked');
        const ids = Array.from(checkboxes).map(cb => Number(cb.getAttribute('data-id')));
        const users = []; const colors = ['#e11d48', '#2563eb', '#16a34a', '#d97706', '#9333ea', '#0891b2'];
        ids.forEach((id, index) => { const p = discRawData.find(x => Number(x.id) === id); if(p) users.push({ name: p.name, least: p.least, most: p.most, color: colors[index % colors.length] }); });
        drawMultiDiscChart('admin-disc-chart-least', users, 'least', GRAPH_II_MAPPING, { midlineIndex: 7, numRows: 20 }, 'legend-current');
        drawMultiDiscChart('admin-disc-chart-most', users, 'most', GRAPH_III_MAPPING, { midlineIndex: 12, numRows: 22 }, 'legend-trend');
    }
    
    // --- CULTURE FIT ANALYSIS FUNCTIONS ---
    function updateCultureCandidateDatalist() {
        const datalist = document.getElementById('disc-culture-candidates-list'); datalist.innerHTML = '';
        discRawData.forEach(item => { 
            if (!discCultureSelectedCandidates.includes(Number(item.id))) {
                datalist.innerHTML += `<option value="${item.name} | ${item.position}"></option>`;
            }
        });
    }
    
    function addPersonToCultureAnalysis() {
        const input = document.getElementById('disc-culture-search-input'); 
        const val = input.value.trim(); 
        if(!val) return;
        
        const person = discRawData.find(x => `${x.name} | ${x.position}` === val);
        if(person && !discCultureSelectedCandidates.includes(Number(person.id))) { 
            discCultureSelectedCandidates.push(Number(person.id)); 
            renderCultureTable(); 
            updateCultureCandidateDatalist(); 
        }
        input.value = "";
    }
    
    function renderCultureTable() {
        const tbody = document.getElementById('disc-culture-table-body'); 
        tbody.innerHTML = ''; 
        
        discCultureSelectedCandidates.forEach(id => {
            const p = discRawData.find(x => Number(x.id) === id);
            if(p) {
                const fmt = (s) => (s || "").replace(/\n/g, '<br>‚Ä¢ ');
                const getCount = (str) => str ? str.split('\n').filter(x => x.trim()).length : 0;

                const countMF = getCount(p.strMostFit);
                const labelMF = `<div class="mb-1 font-bold text-green-800 text-center border-b border-green-200 pb-1">(${countMF}/${discTotalFit})</div>`;
                const mf = p.strMostFit ? labelMF + '‚Ä¢ ' + fmt(p.strMostFit) : labelMF;

                const countLF = getCount(p.strLeastFit);
                const labelLF = `<div class="mb-1 font-bold text-yellow-800 text-center border-b border-yellow-200 pb-1">(${countLF}/${discTotalFit})</div>`;
                const lf = p.strLeastFit ? labelLF + '‚Ä¢ ' + fmt(p.strLeastFit) : labelLF;

                const countNF = getCount(p.strMostNonFit);
                const labelNF = `<div class="mb-1 font-bold text-red-800 text-center border-b border-red-200 pb-1">(${countNF}/${discTotalNonFit})</div>`;
                const mnf = p.strMostNonFit ? labelNF + '‚Ä¢ ' + fmt(p.strMostNonFit) : labelNF;
                
                tbody.innerHTML += `
                    <tr class="hover:bg-purple-50 transition-colors border-b">
                        <td class="p-3 border border-gray-200 font-bold text-deepBlue align-top text-center">${p.name}</td>
                        <td class="p-3 border border-gray-200 text-xs text-gray-600 align-top text-center">${p.position}</td>
                        <td class="p-3 border border-gray-200 text-center font-bold text-blue-600 align-top text-center">${p.currentDiscStr}</td>
                        <td class="p-3 border border-gray-200 text-center font-bold text-orange-600 align-top text-center">${p.trendDiscStr}</td>
                        <td class="p-3 border border-gray-200 text-xs align-top leading-relaxed text-gray-800 bg-green-50/50">${mf}</td>
                        <td class="p-3 border border-gray-200 text-xs align-top leading-relaxed text-gray-800 bg-yellow-50/50">${lf}</td>
                        <td class="p-3 border border-gray-200 text-xs align-top leading-relaxed text-gray-800 bg-red-50/50">${mnf}</td>
                    </tr>`;
            }
        });
    }

    // --- DISC TIME ANALYSIS (NEW) ---
    function populateDiscTimeEmployeeDropdown() {
        const select = document.getElementById('disc-time-employee-select');
        // Get unique names, sorted alphabetically from VISIBLE data (for scope)
        const uniqueNames = [...new Set(discRawData.map(i => i.name))].sort();
        select.innerHTML = '<option value="" disabled selected>-- Ch·ªçn nh√¢n vi√™n --</option>';
        uniqueNames.forEach(name => {
            select.innerHTML += `<option value="${name}">${name}</option>`;
        });
    }

    function handleDiscTimeEmployeeChange() {
        const select = document.getElementById('disc-time-employee-select');
        const selectedName = select.value;
        if (!selectedName) return;

        // Clear everything
        discTimeSelectedTests = [];
        renderDiscTimeTable();
        updateDiscTimeCharts();

        // Get all tests for this employee from GLOBAL SCOPE (unfiltered by Admin Dept/Area)
        // This ensures full history is visible once an employee is selected
        discTimeAvailableTests = discAllResultsGlobal.filter(i => i.name === selectedName);
        
        // Sort by ID descending (newest first)
        discTimeAvailableTests.sort((a,b) => b.id - a.id);

        // Populate Datalist
        const datalist = document.getElementById('disc-time-tests-list');
        datalist.innerHTML = '';
        discTimeAvailableTests.forEach(test => {
            // Label format: Occasion + Position [Date]
            const dateStr = test.timestamp ? test.timestamp.split(' ')[0] : '';
            const label = `${test.occasion} + ${test.position} [${dateStr}]`;
            datalist.innerHTML += `<option value="${label}" data-id="${test.id}"></option>`;
        });
        
        // Clear Textbox
        document.getElementById('disc-time-search-input').value = "";
    }

    function addTestToTimeAnalysis() {
        const input = document.getElementById('disc-time-search-input');
        const val = input.value.trim();
        if (!val) return;

        // Find test in available list using new label format including date
        const testIndex = discTimeAvailableTests.findIndex(t => {
            const dateStr = t.timestamp ? t.timestamp.split(' ')[0] : '';
            const label = `${t.occasion} + ${t.position} [${dateStr}]`;
            return label === val;
        });
        
        if (testIndex > -1) {
            const test = discTimeAvailableTests[testIndex];
            
            // Add to selected
            discTimeSelectedTests.push(test);
            
            // Remove from available
            discTimeAvailableTests.splice(testIndex, 1);
            
            // Update UI
            renderDiscTimeTable();
            updateDiscTimeCharts();
            
            // Re-populate Datalist
            const datalist = document.getElementById('disc-time-tests-list');
            datalist.innerHTML = '';
            discTimeAvailableTests.forEach(t => {
                const dateStr = t.timestamp ? t.timestamp.split(' ')[0] : '';
                const label = `${t.occasion} + ${t.position} [${dateStr}]`;
                datalist.innerHTML += `<option value="${label}"></option>`;
            });
            
            input.value = "";
        } else {
            alert("Kh√¥ng t√¨m th·∫•y k·ª≥ test n√†y ho·∫∑c ƒë√£ ƒë∆∞·ª£c ch·ªçn.");
        }
    }

    function renderDiscTimeTable() {
        const tbody = document.getElementById('disc-time-table-body');
        tbody.innerHTML = '';
        discTimeSelectedTests.forEach((p, index) => {
            tbody.innerHTML += `<tr class="hover:bg-indigo-50 border-b"><td class="p-2"><div class="font-bold text-indigo-900">${p.occasion}</div><div class="text-[10px] text-gray-500">${p.position}</div></td><td class="p-2"><div class="text-[10px]"><span class="text-blue-600 font-bold">C:</span> ${p.currentDiscStr}</div><div class="text-[10px]"><span class="text-orange-600 font-bold">T:</span> ${p.trendDiscStr}</div></td><td class="p-2 text-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600" checked onchange="updateDiscTimeCharts()" data-index="${index}"></td></tr>`;
        });
        updateDiscTimeCharts();
    }

    function updateDiscTimeCharts() {
        const checkboxes = document.querySelectorAll('#disc-time-table-body input[type="checkbox"]:checked');
        const indices = Array.from(checkboxes).map(cb => Number(cb.getAttribute('data-index')));
        
        const users = []; 
        const colors = ['#e11d48', '#2563eb', '#16a34a', '#d97706', '#9333ea', '#0891b2', '#db2777', '#059669'];
        
        indices.forEach((arrIndex, colorIndex) => {
            const p = discTimeSelectedTests[arrIndex];
            if(p) {
                users.push({ 
                    name: `${p.occasion} - ${p.position}`, 
                    least: p.least, 
                    most: p.most, 
                    color: colors[colorIndex % colors.length] 
                }); 
            }
        });

        drawMultiDiscChart('disc-time-chart-least', users, 'least', GRAPH_II_MAPPING, { midlineIndex: 7, numRows: 20 }, 'legend-time-current');
        drawMultiDiscChart('disc-time-chart-most', users, 'most', GRAPH_III_MAPPING, { midlineIndex: 12, numRows: 22 }, 'legend-time-trend');
    }

    function drawMultiDiscChart(canvasId, users, type, mapping, config, legendId) {
        const canvas = document.getElementById(canvasId); if (!canvas) return; const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1; const parent = canvas.parentElement; canvas.width = parent.clientWidth * dpr; canvas.height = parent.clientHeight * dpr; ctx.scale(dpr, dpr);
        const w = parent.clientWidth, h = parent.clientHeight;
        const cols = ['D', 'I', 'S', 'C']; const numRows = config.numRows; const headerH = 30, margin = 15, gridH = h - headerH - margin, rowH = gridH / numRows, colW = (w - margin * 2) / 4;
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, w, h);
        ctx.font = 'bold 12px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        cols.forEach((col, i) => { ctx.fillStyle = '#000'; ctx.fillText(col, margin + colW * i + colW / 2, headerH / 2); ctx.strokeRect(margin + colW * i, 0, colW, headerH); });
        
        ctx.font = '10px sans-serif'; ctx.lineWidth = 1;
        for (let r = 0; r < numRows; r++) {
            const y = headerH + r * rowH; const rowData = mapping.find(item => item.id === r);
            if (r === config.midlineIndex) { ctx.beginPath(); ctx.moveTo(margin, y + rowH); ctx.lineTo(w - margin, y + rowH); ctx.strokeStyle = '#6b7280'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]); ctx.lineWidth = 1; }
            cols.forEach((col, c) => { const x = margin + colW * c; ctx.beginPath(); ctx.moveTo(x, headerH); ctx.lineTo(x, h - margin); ctx.strokeStyle = '#e5e7eb'; ctx.stroke(); if (rowData && rowData[col] !== null && rowData[col] !== undefined) { ctx.fillStyle = '#9ca3af'; ctx.fillText(rowData[col], x + colW / 2, y + rowH / 2); } });
        }
        ctx.strokeRect(margin, headerH, w - margin * 2, gridH);
        
        users.forEach(user => {
            const scores = user[type]; const points = [];
            cols.forEach((col, c) => {
                const score = scores[col]; const rowIndex = getRowIndex(score, col, mapping);
                if (rowIndex !== -1) points.push({ x: margin + colW * c + colW / 2, y: headerH + rowIndex * rowH + rowH / 2 });
            });
            if (points.length > 0) {
                ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y); for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);
                ctx.strokeStyle = user.color; ctx.lineWidth = 2; ctx.stroke();
                points.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill(); ctx.lineWidth = 2; ctx.strokeStyle = user.color; ctx.stroke(); });
            }
        });
        const leg = document.getElementById(legendId); leg.innerHTML = ''; users.forEach(u => { leg.innerHTML += `<div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full" style="background-color: ${u.color}"></span><span class="font-bold text-gray-700 text-xs">${u.name}</span></div>`; });
    }
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>